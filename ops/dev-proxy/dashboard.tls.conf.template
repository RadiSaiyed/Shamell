server {
  listen 443 ssl;
  server_name _;

  # Local dev TLS termination. This is required for browser clients to
  # accept Secure session cookies (the BFF always sets `Secure`).
  ssl_certificate /etc/nginx/certs/cert.pem;
  ssl_certificate_key /etc/nginx/certs/key.pem;
  ssl_protocols TLSv1.2 TLSv1.3;

  location / {
    proxy_http_version 1.1;
    proxy_set_header Host ${UPSTREAM_HOST_HEADER};
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # Local dev attestation headers for BFF internal guard.
    proxy_set_header X-Internal-Secret ${INTERNAL_SECRET};
    proxy_set_header X-Internal-Service-Id ${CALLER_ID};
    proxy_set_header X-Shamell-Client-IP $remote_addr;

    # Never forward client-supplied privileged role headers.
    #
    # Optional local edge simulation:
    # - AUTH_ROLES: comma-separated roles (e.g. "superadmin")
    # - ROLE_AUTH:  shared secret matching BFF_ROLE_HEADER_SECRET (attests roles are edge-injected)
    #
    # Leaving these empty keeps role headers disabled (default, safest).
    proxy_set_header X-Auth-Roles "${AUTH_ROLES}";
    proxy_set_header X-Roles "${AUTH_ROLES}";
    proxy_set_header X-Role-Auth "${ROLE_AUTH}";

    proxy_pass http://${UPSTREAM_HOSTPORT};
  }
}


# Shamell staging security controls (overlay template).
# Usage:
# 1) copy values into ops/pi/.env
# 2) keep required secrets from your real env file unchanged

ENV=staging

# Required secrets (never commit real values; set strong values in ops/pi/.env)
INTERNAL_API_SECRET=change-me
PAYMENTS_INTERNAL_SECRET=change-me
BUS_INTERNAL_SECRET=change-me
SONIC_SECRET=change-me
TOPUP_SECRET=change-me
ALIAS_CODE_PEPPER=change-me
CASH_SECRET_PEPPER=change-me
BUS_TICKET_SECRET=change-me

# Database safety (prod/staging best practice)
# Avoid auto-creating schema in staging. Use explicit migrations instead.
AUTO_CREATE_SCHEMA=false
RUN_ALEMBIC_ON_STARTUP=false

# Host header allowlist (comma-separated). Include your staging domain(s)
# plus localhost for local health checks.
ALLOWED_HOSTS=staging-api.shamell.online,localhost,127.0.0.1

# Web origins allowed to call the BFF (CORS + CSRF allowlist).
# Must include your web app origin(s) if you rely on cookie sessions.
ALLOWED_ORIGINS=https://online.shamell.online

# Defense-in-depth CSRF guard for cookie sessions.
CSRF_GUARD_ENABLED=true

# Bound in-memory rate/velocity stores (prevents memory DoS under key-spam).
RATE_STORE_MAX_KEYS=20000

# Interactive API docs are disabled by default outside dev/test.
# Set to true only if you explicitly want /docs in staging.
ENABLE_API_DOCS_IN_PROD=false

# Attack-surface reduction: expose only the BFF routes you actually use.
# Enabled by default in staging/prod; keep it on.
BFF_ROUTE_ALLOWLIST_ENABLED=true
# Optional overrides:
# BFF_ROUTE_ALLOWLIST_EXACT=/,/health,/favicon.ico
# BFF_ROUTE_ALLOWLIST_PREFIXES=/auth,/me,/bus,/payments,/chat,/admin

# In prod/staging, prefer the BFF as the only public surface.
# Exposing raw domain routers can bypass BFF AuthZ unless separately hardened.
EXPOSE_PAYMENTS_ROUTER=false
EXPOSE_CHAT_ROUTER=false

# Disable dev-only wallet websocket stream unless explicitly enabled.
ENABLE_WALLET_WS_IN_PROD=false

# Optional: protect metrics ingest endpoint in prod/staging.
# If empty, /metrics ingest is disabled (403).
METRICS_INGEST_SECRET=

# Keep code/OTP exposure disabled outside local dev.
AUTH_EXPOSE_CODES=false
ALIAS_EXPOSE_CODE=false

# Payments edge abuse controls (BFF)
# Profile: strict pre-prod (catch abuse and regressions early).
PAY_API_RATE_WINDOW_SECS=60
PAY_API_REQ_WRITE_MAX_PER_WALLET=20
PAY_API_REQ_WRITE_MAX_PER_IP=80
PAY_API_REQ_READ_MAX_PER_WALLET=100
PAY_API_REQ_READ_MAX_PER_IP=300
PAY_API_FAV_WRITE_MAX_PER_WALLET=15
PAY_API_FAV_WRITE_MAX_PER_IP=60
PAY_API_FAV_READ_MAX_PER_WALLET=100
PAY_API_FAV_READ_MAX_PER_IP=300
PAY_API_RESOLVE_MAX_PER_WALLET=8
PAY_API_RESOLVE_MAX_PER_IP=30

# Chat edge abuse controls (BFF)
CHAT_RATE_WINDOW_SECS=60
CHAT_REGISTER_MAX_PER_IP=12
CHAT_SEND_MAX_PER_DEVICE=80
CHAT_SEND_MAX_PER_IP=150

# Chat WebSocket abuse controls (BFF)
CHAT_WS_CONNECT_WINDOW_SECS=60
CHAT_WS_CONNECT_MAX_PER_IP=30
CHAT_WS_MAX_ACTIVE_PER_IP=10
CHAT_WS_MAX_ACTIVE_PER_DEVICE=2

# LiveKit (publicly reachable, but joining requires server-minted tokens)
# Set LIVEKIT_PUBLIC_URL to the client-facing wss://... endpoint (not the internal docker URL).
LIVEKIT_PUBLIC_URL=
# LiveKit requires strong keys even if the token endpoint is disabled.
# If these are unset in staging/prod, the LiveKit container must not start.
LIVEKIT_API_KEY=
LIVEKIT_API_SECRET=
LIVEKIT_TOKEN_ENDPOINT_ENABLED=false
LIVEKIT_TOKEN_TTL_SECS=300
LIVEKIT_TOKEN_MAX_TTL_SECS=3600
LIVEKIT_TOKEN_RATE_WINDOW_SECS=60
LIVEKIT_TOKEN_MAX_PER_PHONE=20
LIVEKIT_TOKEN_MAX_PER_IP=50

# Runtime security alerting (optional)
SECURITY_ALERT_WEBHOOK_URL=
SECURITY_ALERT_WINDOW_SECS=300
SECURITY_ALERT_COOLDOWN_SECS=300
SECURITY_ALERT_THRESHOLDS=payments_transfer_wallet_mismatch:2,alias_request_wallet_mismatch:2,alias_request_user_override_blocked:2,favorites_owner_wallet_mismatch:2,payments_request_from_wallet_mismatch:2,payments_edge_rate_limit_wallet:8,payments_edge_rate_limit_ip:12,chat_edge_rate_limit_device:20,chat_edge_rate_limit_ip:30,chat_ws_connect_rate_limit_ip:6,chat_ws_active_limit_ip:6,chat_ws_active_limit_device:6

# --- Optional: Postgres-backed stack (ops/pi/docker-compose.postgres.yml) ---
# Leave unset when using the default SQLite volume stack (ops/pi/docker-compose.yml).
#
# POSTGRES_USER=shamell
# POSTGRES_PASSWORD=change-me
# POSTGRES_DB=postgres
# POSTGRES_DB_CORE=shamell_core
# POSTGRES_DB_CHAT=shamell_chat
# POSTGRES_DB_PAYMENTS=shamell_payments
# POSTGRES_DB_BUS=shamell_bus
#
# DB_URL=postgresql+psycopg2://shamell:change-me@db:5432/shamell_core
# CHAT_DB_URL=postgresql+psycopg2://shamell:change-me@db:5432/shamell_chat
# PAYMENTS_DB_URL=postgresql+psycopg2://shamell:change-me@db:5432/shamell_payments
# BUS_DB_URL=postgresql+psycopg2://shamell:change-me@db:5432/shamell_bus

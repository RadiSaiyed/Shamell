services:
  monolith:
    image: shamell-core:pi
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-prod}"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      MONOLITH_MODE: "${MONOLITH_MODE:-1}"
      MONOLITH_ONLY: "${MONOLITH_ONLY:-1}"
      MONOLITH_DB_URL: "${MONOLITH_DB_URL:-sqlite+pysqlite:////data/monolith.db}"
      PAYMENTS_DB_URL: "${PAYMENTS_DB_URL:-sqlite+pysqlite:////data/payments.db}"
      DB_URL: "${DB_URL:-sqlite+pysqlite:////data/core.db}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in ops/pi/.env}"
      PAYMENTS_INTERNAL_SECRET: "${PAYMENTS_INTERNAL_SECRET:?set PAYMENTS_INTERNAL_SECRET in ops/pi/.env}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
      ADMIN_TOKEN_SHA256: "${ADMIN_TOKEN_SHA256:-}"
      PAY_API_RATE_WINDOW_SECS: "${PAY_API_RATE_WINDOW_SECS:-60}"
      PAY_API_REQ_WRITE_MAX_PER_WALLET: "${PAY_API_REQ_WRITE_MAX_PER_WALLET:-45}"
      PAY_API_REQ_WRITE_MAX_PER_IP: "${PAY_API_REQ_WRITE_MAX_PER_IP:-180}"
      PAY_API_REQ_READ_MAX_PER_WALLET: "${PAY_API_REQ_READ_MAX_PER_WALLET:-180}"
      PAY_API_REQ_READ_MAX_PER_IP: "${PAY_API_REQ_READ_MAX_PER_IP:-700}"
      PAY_API_FAV_WRITE_MAX_PER_WALLET: "${PAY_API_FAV_WRITE_MAX_PER_WALLET:-30}"
      PAY_API_FAV_WRITE_MAX_PER_IP: "${PAY_API_FAV_WRITE_MAX_PER_IP:-120}"
      PAY_API_FAV_READ_MAX_PER_WALLET: "${PAY_API_FAV_READ_MAX_PER_WALLET:-180}"
      PAY_API_FAV_READ_MAX_PER_IP: "${PAY_API_FAV_READ_MAX_PER_IP:-700}"
      PAY_API_RESOLVE_MAX_PER_WALLET: "${PAY_API_RESOLVE_MAX_PER_WALLET:-15}"
      PAY_API_RESOLVE_MAX_PER_IP: "${PAY_API_RESOLVE_MAX_PER_IP:-90}"
      # Chat edge abuse controls (BFF)
      CHAT_RATE_WINDOW_SECS: "${CHAT_RATE_WINDOW_SECS:-60}"
      CHAT_REGISTER_MAX_PER_IP: "${CHAT_REGISTER_MAX_PER_IP:-25}"
      CHAT_SEND_MAX_PER_DEVICE: "${CHAT_SEND_MAX_PER_DEVICE:-120}"
      CHAT_SEND_MAX_PER_IP: "${CHAT_SEND_MAX_PER_IP:-300}"
      # Chat WebSocket abuse controls (BFF)
      CHAT_WS_CONNECT_WINDOW_SECS: "${CHAT_WS_CONNECT_WINDOW_SECS:-60}"
      CHAT_WS_CONNECT_MAX_PER_IP: "${CHAT_WS_CONNECT_MAX_PER_IP:-60}"
      CHAT_WS_MAX_ACTIVE_PER_IP: "${CHAT_WS_MAX_ACTIVE_PER_IP:-20}"
      CHAT_WS_MAX_ACTIVE_PER_DEVICE: "${CHAT_WS_MAX_ACTIVE_PER_DEVICE:-3}"
      SECURITY_ALERT_WEBHOOK_URL: "${SECURITY_ALERT_WEBHOOK_URL:-}"
      SECURITY_ALERT_WINDOW_SECS: "${SECURITY_ALERT_WINDOW_SECS:-300}"
      SECURITY_ALERT_COOLDOWN_SECS: "${SECURITY_ALERT_COOLDOWN_SECS:-600}"
      SECURITY_ALERT_THRESHOLDS: "${SECURITY_ALERT_THRESHOLDS:-payments_transfer_wallet_mismatch:4,alias_request_wallet_mismatch:4,alias_request_user_override_blocked:4,favorites_owner_wallet_mismatch:4,payments_request_from_wallet_mismatch:4,payments_edge_rate_limit_wallet:25,payments_edge_rate_limit_ip:40}"
      LIVEKIT_URL: "${LIVEKIT_URL:-ws://livekit:7880}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-}"
    volumes:
      - monolith_data:/data
    ports:
      - "${MONOLITH_PUBLISH_ADDR:-127.0.0.1}:8080:8080"
    command: ["uvicorn", "apps.monolith.app.main:app", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      - livekit
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s

  livekit:
    image: livekit/livekit-server:v1.5.2
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./livekit:/etc/livekit:ro
    ports:
      - "${LIVEKIT_PUBLISH_ADDR:-0.0.0.0}:7880:7880"
      - "${LIVEKIT_PUBLISH_ADDR:-0.0.0.0}:7881:7881"
      - "${LIVEKIT_PUBLISH_ADDR:-0.0.0.0}:7882:7882/udp"
    restart: unless-stopped

volumes:
  monolith_data:

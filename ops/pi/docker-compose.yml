services:
  bootstrap-perms:
    image: alpine:3.19
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
    read_only: true
    tmpfs:
      - /tmp
    network_mode: none
    command:
      - /bin/sh
      - -ceu
      - |
        uid=10001
        gid=10001

        # Ensure the runtime UID/GID can write service volumes.
        for d in /vol/bff_data /vol/chat_data /vol/payments_data /vol/bus_data; do
          [ -d "$$d" ] || continue
          owner="$$(stat -c '%u:%g' "$$d" 2>/dev/null || true)"
          if [ "$$owner" = "$$uid:$$gid" ]; then
            continue
          fi
          echo "Fixing ownership: $$d -> $${uid}:$${gid} (was $${owner:-unknown})" >&2
          chown -R "$${uid}:$${gid}" "$$d"
        done
    volumes:
      - bff_data:/vol/bff_data
      - chat_data:/vol/chat_data
      - payments_data:/vol/payments_data
      - bus_data:/vol/bus_data

  bff:
    image: shamell-core:pi
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-prod}"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      DB_URL: "${DB_URL:-sqlite+pysqlite:////data/core.db}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in ops/pi/.env}"
      PAYMENTS_INTERNAL_SECRET: "${PAYMENTS_INTERNAL_SECRET:?set PAYMENTS_INTERNAL_SECRET in ops/pi/.env}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:?set BUS_INTERNAL_SECRET in ops/pi/.env}"
      CHAT_BASE_URL: "${CHAT_BASE_URL:-http://chat:8081}"
      PAYMENTS_BASE_URL: "${PAYMENTS_BASE_URL:-http://payments:8082}"
      BUS_BASE_URL: "${BUS_BASE_URL:-http://bus:8083}"
      BUS_INTERNAL_MODE: "off"
      FORCE_INTERNAL_DOMAINS: "false"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
      CSRF_GUARD_ENABLED: "${CSRF_GUARD_ENABLED:-true}"
      RATE_STORE_MAX_KEYS: "${RATE_STORE_MAX_KEYS:-20000}"
      ENABLE_API_DOCS_IN_PROD: "${ENABLE_API_DOCS_IN_PROD:-false}"
      EXPOSE_PAYMENTS_ROUTER: "${EXPOSE_PAYMENTS_ROUTER:-false}"
      EXPOSE_CHAT_ROUTER: "${EXPOSE_CHAT_ROUTER:-false}"
      ENABLE_WALLET_WS_IN_PROD: "${ENABLE_WALLET_WS_IN_PROD:-false}"
      METRICS_INGEST_SECRET: "${METRICS_INGEST_SECRET:-}"
      AUTH_EXPOSE_CODES: "${AUTH_EXPOSE_CODES:-false}"
      ALIAS_EXPOSE_CODE: "${ALIAS_EXPOSE_CODE:-false}"
      TRUST_PROXY_HEADERS: "${TRUST_PROXY_HEADERS:-auto}"
      TRUST_PRIVATE_PROXY_HOPS: "${TRUST_PRIVATE_PROXY_HOPS:-true}"
      TRUSTED_PROXY_CIDRS: "${TRUSTED_PROXY_CIDRS:-}"
      # UnifiedPush callback guardrails (SSRF prevention)
      PUSH_ALLOWED_HOSTS: "${PUSH_ALLOWED_HOSTS:-}"
      PUSH_ALLOW_HTTP: "${PUSH_ALLOW_HTTP:-false}"
      PUSH_ALLOW_PRIVATE_IPS: "${PUSH_ALLOW_PRIVATE_IPS:-false}"
      PUSH_VALIDATE_DNS: "${PUSH_VALIDATE_DNS:-true}"
      PUSH_MAX_ENDPOINT_LEN: "${PUSH_MAX_ENDPOINT_LEN:-2048}"
      # CPU-bound fleet helper caps
      FLEET_MAX_STOPS: "${FLEET_MAX_STOPS:-200}"
      FLEET_MAX_DEPOTS: "${FLEET_MAX_DEPOTS:-50}"
      ADMIN_TOKEN_SHA256: "${ADMIN_TOKEN_SHA256:-}"
      PAY_API_RATE_WINDOW_SECS: "${PAY_API_RATE_WINDOW_SECS:-60}"
      PAY_API_REQ_WRITE_MAX_PER_WALLET: "${PAY_API_REQ_WRITE_MAX_PER_WALLET:-45}"
      PAY_API_REQ_WRITE_MAX_PER_IP: "${PAY_API_REQ_WRITE_MAX_PER_IP:-180}"
      PAY_API_REQ_READ_MAX_PER_WALLET: "${PAY_API_REQ_READ_MAX_PER_WALLET:-180}"
      PAY_API_REQ_READ_MAX_PER_IP: "${PAY_API_REQ_READ_MAX_PER_IP:-700}"
      PAY_API_FAV_WRITE_MAX_PER_WALLET: "${PAY_API_FAV_WRITE_MAX_PER_WALLET:-30}"
      PAY_API_FAV_WRITE_MAX_PER_IP: "${PAY_API_FAV_WRITE_MAX_PER_IP:-120}"
      PAY_API_FAV_READ_MAX_PER_WALLET: "${PAY_API_FAV_READ_MAX_PER_WALLET:-180}"
      PAY_API_FAV_READ_MAX_PER_IP: "${PAY_API_FAV_READ_MAX_PER_IP:-700}"
      PAY_API_RESOLVE_MAX_PER_WALLET: "${PAY_API_RESOLVE_MAX_PER_WALLET:-15}"
      PAY_API_RESOLVE_MAX_PER_IP: "${PAY_API_RESOLVE_MAX_PER_IP:-90}"
      # Chat edge abuse controls (BFF)
      CHAT_RATE_WINDOW_SECS: "${CHAT_RATE_WINDOW_SECS:-60}"
      CHAT_REGISTER_MAX_PER_IP: "${CHAT_REGISTER_MAX_PER_IP:-25}"
      CHAT_SEND_MAX_PER_DEVICE: "${CHAT_SEND_MAX_PER_DEVICE:-120}"
      CHAT_SEND_MAX_PER_IP: "${CHAT_SEND_MAX_PER_IP:-300}"
      # Chat WebSocket abuse controls (BFF)
      CHAT_WS_CONNECT_WINDOW_SECS: "${CHAT_WS_CONNECT_WINDOW_SECS:-60}"
      CHAT_WS_CONNECT_MAX_PER_IP: "${CHAT_WS_CONNECT_MAX_PER_IP:-60}"
      CHAT_WS_MAX_ACTIVE_PER_IP: "${CHAT_WS_MAX_ACTIVE_PER_IP:-20}"
      CHAT_WS_MAX_ACTIVE_PER_DEVICE: "${CHAT_WS_MAX_ACTIVE_PER_DEVICE:-3}"
      SECURITY_ALERT_WEBHOOK_URL: "${SECURITY_ALERT_WEBHOOK_URL:-}"
      SECURITY_ALERT_WINDOW_SECS: "${SECURITY_ALERT_WINDOW_SECS:-300}"
      SECURITY_ALERT_COOLDOWN_SECS: "${SECURITY_ALERT_COOLDOWN_SECS:-600}"
      SECURITY_ALERT_THRESHOLDS: "${SECURITY_ALERT_THRESHOLDS:-payments_transfer_wallet_mismatch:4,alias_request_wallet_mismatch:4,alias_request_user_override_blocked:4,favorites_owner_wallet_mismatch:4,payments_request_from_wallet_mismatch:4,payments_edge_rate_limit_wallet:25,payments_edge_rate_limit_ip:40}"
      # LiveKit (publicly reachable, but joining requires server-minted tokens)
      LIVEKIT_URL: "${LIVEKIT_URL:-ws://livekit:7880}"
      LIVEKIT_PUBLIC_URL: "${LIVEKIT_PUBLIC_URL:-}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-}"
      LIVEKIT_TOKEN_ENDPOINT_ENABLED: "${LIVEKIT_TOKEN_ENDPOINT_ENABLED:-false}"
      LIVEKIT_TOKEN_TTL_SECS: "${LIVEKIT_TOKEN_TTL_SECS:-300}"
      LIVEKIT_TOKEN_MAX_TTL_SECS: "${LIVEKIT_TOKEN_MAX_TTL_SECS:-3600}"
      LIVEKIT_TOKEN_RATE_WINDOW_SECS: "${LIVEKIT_TOKEN_RATE_WINDOW_SECS:-60}"
      LIVEKIT_TOKEN_MAX_PER_PHONE: "${LIVEKIT_TOKEN_MAX_PER_PHONE:-30}"
      LIVEKIT_TOKEN_MAX_PER_IP: "${LIVEKIT_TOKEN_MAX_PER_IP:-80}"
    volumes:
      - bff_data:/data
    ports:
      - "${BFF_PUBLISH_ADDR:-127.0.0.1}:${BFF_PUBLISH_PORT:-8080}:8080"
    command: ["uvicorn", "apps.bff.app.main:app", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
      chat:
        condition: service_healthy
      payments:
        condition: service_healthy
      bus:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s

  chat:
    image: shamell-core:pi
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-prod}"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      DB_URL: "sqlite+pysqlite:////data/chat.db"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in ops/pi/.env}"
      CHAT_REQUIRE_INTERNAL_SECRET: "true"
      ENABLE_API_DOCS_IN_PROD: "${ENABLE_API_DOCS_IN_PROD:-false}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - chat_data:/data
    command: ["uvicorn", "apps.chat.app.main:app", "--host", "0.0.0.0", "--port", "8081"]
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s

  payments:
    image: shamell-core:pi
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-prod}"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      PAYMENTS_DB_URL: "${PAYMENTS_DB_URL:-sqlite+pysqlite:////data/payments.db}"
      AUTO_CREATE_SCHEMA: "${AUTO_CREATE_SCHEMA:-true}"
      RUN_ALEMBIC_ON_STARTUP: "${RUN_ALEMBIC_ON_STARTUP:-false}"
      # IMPORTANT: payments uses INTERNAL_API_SECRET; point it to PAYMENTS_INTERNAL_SECRET
      # so BFF-to-payments internal calls validate against the dedicated payments secret.
      INTERNAL_API_SECRET: "${PAYMENTS_INTERNAL_SECRET:?set PAYMENTS_INTERNAL_SECRET in ops/pi/.env}"
      PAYMENTS_REQUIRE_INTERNAL_SECRET: "true"
      SONIC_SECRET: "${SONIC_SECRET:?set SONIC_SECRET in ops/pi/.env}"
      TOPUP_SECRET: "${TOPUP_SECRET:?set TOPUP_SECRET in ops/pi/.env}"
      ALIAS_CODE_PEPPER: "${ALIAS_CODE_PEPPER:?set ALIAS_CODE_PEPPER in ops/pi/.env}"
      CASH_SECRET_PEPPER: "${CASH_SECRET_PEPPER:?set CASH_SECRET_PEPPER in ops/pi/.env}"
      ADMIN_TOKEN_SHA256: "${ADMIN_TOKEN_SHA256:-}"
      ENABLE_API_DOCS_IN_PROD: "${ENABLE_API_DOCS_IN_PROD:-false}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - payments_data:/data
    command: ["uvicorn", "apps.payments.app.main:app", "--host", "0.0.0.0", "--port", "8082"]
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8082/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s

  bus:
    image: shamell-core:pi
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-prod}"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      BUS_DB_URL: "${BUS_DB_URL:-sqlite+pysqlite:////data/bus.db}"
      BUS_TICKET_SECRET: "${BUS_TICKET_SECRET:?set BUS_TICKET_SECRET in ops/pi/.env}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:?set BUS_INTERNAL_SECRET in ops/pi/.env}"
      BUS_REQUIRE_INTERNAL_SECRET: "true"
      ENABLE_API_DOCS_IN_PROD: "${ENABLE_API_DOCS_IN_PROD:-false}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - bus_data:/data
    command: ["uvicorn", "apps.bus.app.main:app", "--host", "0.0.0.0", "--port", "8083"]
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8083/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s

  livekit:
    image: livekit/livekit-server:v1.5.2
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      # Never allow dev defaults in prod/staging: if keys are unset, fail fast.
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:?set LIVEKIT_API_KEY in ops/pi/.env}: ${LIVEKIT_API_SECRET:?set LIVEKIT_API_SECRET in ops/pi/.env}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./livekit:/etc/livekit:ro
    ports:
      # Serve LiveKit's HTTP/WebSocket API on localhost by default; terminate TLS in Nginx.
      - "${LIVEKIT_HTTP_PUBLISH_ADDR:-127.0.0.1}:${LIVEKIT_HTTP_PORT:-7880}:7880"
      # RTC ports must be publicly reachable for WebRTC media.
      - "${LIVEKIT_RTC_PUBLISH_ADDR:-0.0.0.0}:${LIVEKIT_TCP_PORT:-7881}:7881"
      - "${LIVEKIT_RTC_PUBLISH_ADDR:-0.0.0.0}:${LIVEKIT_UDP_PORT:-7882}:7882/udp"
    restart: unless-stopped

volumes:
  bff_data:
  chat_data:
  payments_data:
  bus_data:

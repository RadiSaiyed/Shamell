name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Gitleaks fallback
        run: echo "Gitleaks step completed."

  security-python:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install bandit pip-audit

      - name: Bandit
        run: |
          if find . -type f -name '*.py' | grep -q .; then
            python -m bandit -q -r apps libs/shamell_shared/python/shamell_shared scripts -lll -x './.git,./.venv,./venv,./node_modules,./NonWeChat'
          else
            echo "No Python sources found; skipping bandit."
          fi

      - name: pip-audit
        run: |
          REQ_FILES=$(find . -type f \( -name 'requirements.txt' -o -name 'requirements-*.txt' \))
          if [ -n "$REQ_FILES" ]; then
            for f in $REQ_FILES; do
              echo "Auditing $f"
              python -m pip_audit -r "$f" --progress-spinner off
            done
          else
            echo "No requirements files found; skipping pip-audit."
          fi

  codeql:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3.32.2
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3.32.2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3.32.2
        with:
          category: "/language:python"

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high

      - name: Dependency Review Fallback
        run: |
          echo "Dependency review executed (or skipped if unsupported by repository settings)."

  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: YAML lint
        run: |
          python -m pip install --upgrade pip
          python -m pip install yamllint
          yamllint -d "{extends: default, rules: {document-start: disable, truthy: disable, comments: disable, line-length: disable}}" .github/workflows

  python-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/monolith/requirements.txt
          pip install -e libs/shamell_shared/python
          pip install pytest

      - name: Compile sources
        run: |
          python -m compileall -q apps libs NonWeChat

      - name: Run pytest
        env:
          ENV: test
          MONOLITH_MODE: "1"
          PYTHONPATH: .
        run: |
          pytest -q

  semgrep-authz-idor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep

      - name: Run custom AuthZ/IDOR rules
        run: |
          semgrep \
            --config .semgrep/rules/authz-idor.yml \
            --error \
            --exclude .git \
            --exclude .github \
            --exclude .semgrep \
            apps/bff apps/chat apps/monolith

  flutter:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup Flutter
        uses: subosito/flutter-action@1508160852fb97248640997f7cfb38da241df0ba # v2.9.1
        with:
          channel: stable

      - name: Flutter pub get
        working-directory: clients/shamell_flutter
        run: flutter pub get

      - name: Flutter smoke test
        working-directory: clients/shamell_flutter
        run: flutter test test/ratchet_kdf_test.dart

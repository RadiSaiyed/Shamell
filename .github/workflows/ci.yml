name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Detect Rust workspace
        id: detect_rust
        run: |
          if [[ -f Cargo.toml ]]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL (Rust)
        if: steps.detect_rust.outputs.present == 'true'
        uses: github/codeql-action/init@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          languages: rust

      - name: Autobuild
        if: steps.detect_rust.outputs.present == 'true'
        uses: github/codeql-action/autobuild@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4

      - name: Perform CodeQL Analysis
        if: steps.detect_rust.outputs.present == 'true'
        uses: github/codeql-action/analyze@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          category: "/language:rust"

      - name: Skip note (no Cargo.toml)
        if: steps.detect_rust.outputs.present != 'true'
        run: echo "No Cargo.toml found; skipping Rust CodeQL analysis for this branch."

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high

  actionlint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Run actionlint
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/repo" \
            -w /repo \
            rhysd/actionlint:1.7.8

  shellcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends shellcheck

      - name: Run shellcheck on repository scripts
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t shell_files < <(git ls-files '*.sh')
          if [[ "${#shell_files[@]}" -eq 0 ]]; then
            echo "No shell scripts found."
            exit 0
          fi
          shellcheck --shell=bash --severity=warning "${shell_files[@]}"

  rust:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Detect Rust workspace
        id: detect_rust
        run: |
          if [[ -f Cargo.toml ]]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Rust
        if: steps.detect_rust.outputs.present == 'true'
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Rust cache
        if: steps.detect_rust.outputs.present == 'true'
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Make scripts executable
        if: steps.detect_rust.outputs.present == 'true'
        run: chmod +x scripts/*.sh

      - name: cargo fmt
        if: steps.detect_rust.outputs.present == 'true'
        run: cargo fmt --check

      - name: cargo clippy
        if: steps.detect_rust.outputs.present == 'true'
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: cargo test
        if: steps.detect_rust.outputs.present == 'true'
        run: cargo test

      - name: Install cargo-audit
        if: steps.detect_rust.outputs.present == 'true'
        run: cargo install cargo-audit --locked --version 0.22.1

      - name: cargo audit
        if: steps.detect_rust.outputs.present == 'true'
        run: cargo audit -D warnings

      - name: Guard legacy artifacts are absent
        if: steps.detect_rust.outputs.present == 'true'
        run: ./scripts/check_no_legacy_artifacts.sh

      - name: Guard internal port exposure
        if: steps.detect_rust.outputs.present == 'true'
        run: ./scripts/check_internal_port_exposure.sh

      - name: Guard Nginx edge hardening
        if: steps.detect_rust.outputs.present == 'true'
        run: ./scripts/check_nginx_edge_hardening.sh

      - name: Skip note (no Cargo.toml)
        if: steps.detect_rust.outputs.present != 'true'
        run: echo "No Cargo.toml found; skipping Rust CI job for this branch."

  flutter:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup Flutter
        uses: subosito/flutter-action@1508160852fb97248640997f7cfb38da241df0ba # v2.9.1
        with:
          channel: stable

      - name: Flutter pub get
        working-directory: clients/shamell_flutter
        run: flutter pub get

      - name: Flutter smoke test
        working-directory: clients/shamell_flutter
        run: flutter test test/ratchet_kdf_test.dart

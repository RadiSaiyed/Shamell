name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-python:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install bandit pip-audit

      - name: Bandit (if python files exist)
        run: |
          if find . -type f -name '*.py' | grep -q .; then
            python -m bandit -q -r . -x './.git,./.venv,./venv,./node_modules'
          else
            echo "No Python sources found; skipping bandit."
          fi

      - name: pip-audit (if requirements files exist)
        run: |
          REQ_FILES=$(find . -type f \( -name 'requirements.txt' -o -name 'requirements-*.txt' \))
          if [ -n "$REQ_FILES" ]; then
            for f in $REQ_FILES; do
              echo "Auditing $f"
              python -m pip_audit -r "$f" --progress-spinner off
            done
          else
            echo "No requirements files found; skipping pip-audit."
          fi

  codeql:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Detect Python sources
        id: detect-python
        run: |
          if find . -type f -name '*.py' | grep -q .; then
            echo "has_python=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_python=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL
        if: steps.detect-python.outputs.has_python == 'true'
        uses: github/codeql-action/init@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3.32.2
        with:
          languages: python

      - name: Perform CodeQL Analysis
        if: steps.detect-python.outputs.has_python == 'true'
        uses: github/codeql-action/analyze@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3.32.2

      - name: Skip CodeQL (no python files)
        if: steps.detect-python.outputs.has_python != 'true'
        run: echo "No Python sources found; CodeQL Python analysis skipped."

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        continue-on-error: true
        with:
          fail-on-severity: high

      - name: Dependency Review Fallback
        run: |
          echo "Dependency review executed (or skipped if unsupported by repository settings)."

  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: YAML lint
        run: |
          python -m pip install --upgrade pip
          python -m pip install yamllint
          yamllint -d "{extends: default, rules: {document-start: disable, truthy: disable, comments: disable, line-length: disable}}" .github/workflows

  semgrep-authz-idor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep

      - name: Run custom AuthZ/IDOR rules
        run: |
          semgrep \
            --config .semgrep/rules/authz-idor.yml \
            --error \
            --exclude .git \
            --exclude .github \
            --exclude .semgrep \
            .

  flutter:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: No Flutter project in this repository
        run: |
          echo "No Flutter client in this repository; check is intentionally a no-op."

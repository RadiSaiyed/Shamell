name: Flutter iOS Beta (TestFlight)

'on':
  workflow_dispatch:
    inputs:
      require_production_signing:
        description: Require production signing secrets and fail if missing
        required: false
        type: boolean
        default: true
      upload_testflight:
        description: Upload signed IPA to TestFlight
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  ios-beta:
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      REQUIRE_PRODUCTION_SIGNING: ${{ inputs.require_production_signing && 'true' || 'false' }}
      REQUIRE_TESTFLIGHT_UPLOAD: ${{ inputs.upload_testflight && 'true' || 'false' }}
      IOS_DISTRIBUTION_CERTIFICATE_P12_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_P12_BASE64 }}
      IOS_DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}
      IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      APP_STORE_CONNECT_API_KEY_JSON: ${{ secrets.APP_STORE_CONNECT_API_KEY_JSON }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup Flutter
        uses: subosito/flutter-action@1508160852fb97248640997f7cfb38da241df0ba # v2.9.1
        with:
          flutter-version: "3.38.5"

      - name: Flutter pub get
        working-directory: clients/shamell_flutter
        run: flutter pub get

      - name: Verify iOS signing environment
        run: ./scripts/check_ios_release_signing_env.sh

      - name: Install iOS signing assets
        if: ${{ env.REQUIRE_PRODUCTION_SIGNING == 'true' }}
        run: |
          set -euo pipefail
          keychain="$RUNNER_TEMP/shamell-signing.keychain-db"
          keychain_password="$(openssl rand -hex 20)"
          security create-keychain -p "$keychain_password" "$keychain"
          security set-keychain-settings -lut 21600 "$keychain"
          security unlock-keychain -p "$keychain_password" "$keychain"
          security import "$IOS_CERT_PATH" \
            -k "$keychain" \
            -P "$IOS_DISTRIBUTION_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security list-keychains -d user -s "$keychain"
          security default-keychain -s "$keychain"
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          fallback_profile="$HOME/Library/MobileDevice/Provisioning Profiles/shamell.mobileprovision"
          cp "$IOS_PROFILE_PATH" "$fallback_profile"
          profile_plist="$RUNNER_TEMP/shamell-profile.plist"
          if security cms -D -i "$IOS_PROFILE_PATH" > "$profile_plist" 2>/dev/null; then
            profile_uuid="$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$profile_plist" 2>/dev/null || true)"
            if [ -n "${profile_uuid:-}" ]; then
              cp "$IOS_PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$profile_uuid.mobileprovision"
            else
              echo "Could not extract provisioning profile UUID; using fallback profile filename."
            fi
          else
            echo "Provisioning profile is not CMS-decodable; using fallback profile filename."
          fi
          security find-identity -v -p codesigning "$keychain"

      - name: iOS build (signed IPA)
        if: ${{ env.REQUIRE_PRODUCTION_SIGNING == 'true' }}
        working-directory: clients/shamell_flutter
        run: |
          set -euo pipefail
          flutter build ipa --release --export-method app-store --no-pub
          IPA_REL_PATH="$(find build/ios/ipa -type f -name '*.ipa' | head -n 1 || true)"
          if [ -z "${IPA_REL_PATH}" ]; then
            echo "::error::Signed IPA export missing after flutter build ipa. Check iOS distribution certificate/profile and Apple account alignment."
            echo "::notice::Codesigning identities visible to the runner:"
            security find-identity -v -p codesigning || true
            echo "::notice::Provisioning profiles installed on runner:"
            ls -1 "$HOME/Library/MobileDevice/Provisioning Profiles" || true
            exit 1
          fi
          echo "IPA_PATH=${GITHUB_WORKSPACE}/clients/shamell_flutter/${IPA_REL_PATH}" >> "$GITHUB_ENV"

      - name: iOS build (no codesign fallback)
        if: ${{ env.REQUIRE_PRODUCTION_SIGNING != 'true' }}
        working-directory: clients/shamell_flutter
        run: flutter build ios --release --no-codesign --no-pub

      - name: Verify IPA code signature
        if: ${{ env.REQUIRE_PRODUCTION_SIGNING == 'true' }}
        run: |
          set -euo pipefail
          workdir="$(mktemp -d)"
          unzip -q "$IPA_PATH" -d "$workdir"
          codesign -dv --verbose=4 "$workdir/Payload/Runner.app"

      - name: Upload signed iOS IPA artifact
        if: ${{ env.REQUIRE_PRODUCTION_SIGNING == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: shamell-ios-release-ipa
          path: ${{ env.IPA_PATH }}
          if-no-files-found: error

      - name: Detect App Store credentials
        if: ${{ env.REQUIRE_TESTFLIGHT_UPLOAD == 'true' }}
        run: |
          if [ -n "${APP_STORE_CONNECT_API_KEY_JSON:-}" ]; then
            echo "HAS_APPSTORE_CREDENTIALS=true" >> "$GITHUB_ENV"
          else
            echo "HAS_APPSTORE_CREDENTIALS=false" >> "$GITHUB_ENV"
          fi

      - name: Install fastlane
        if: ${{ env.REQUIRE_TESTFLIGHT_UPLOAD == 'true' && env.HAS_APPSTORE_CREDENTIALS == 'true' }}
        run: sudo gem install fastlane

      - name: Write App Store Connect API key
        if: ${{ env.REQUIRE_TESTFLIGHT_UPLOAD == 'true' && env.HAS_APPSTORE_CREDENTIALS == 'true' }}
        working-directory: clients/shamell_flutter/ios
        run: |
          printf '%s' "${APP_STORE_CONNECT_API_KEY_JSON}" > appstore_api_key.json

      - name: Fastlane beta (TestFlight)
        if: ${{ env.REQUIRE_TESTFLIGHT_UPLOAD == 'true' && env.HAS_APPSTORE_CREDENTIALS == 'true' }}
        working-directory: clients/shamell_flutter/ios
        env:
          APP_STORE_CONNECT_API_KEY_PATH: appstore_api_key.json
        run: |
          fastlane beta

      - name: Skip note (credentials missing)
        if: ${{ env.REQUIRE_TESTFLIGHT_UPLOAD == 'true' && env.HAS_APPSTORE_CREDENTIALS != 'true' }}
        run: |
          echo "Skipping TestFlight upload: APP_STORE_CONNECT_API_KEY_JSON is not configured."

<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Shamell · Device login demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #020617; color: #e5e7eb; }
      .page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
      .card { max-width: 480px; width: 100%; background: rgba(15,23,42,0.95); border-radius: 12px; padding: 20px 20px 16px; box-shadow: 0 18px 45px rgba(0,0,0,0.45); border: 1px solid rgba(148,163,184,0.45); }
      h1 { font-size: 20px; margin: 0 0 4px; }
      p { margin: 4px 0; font-size: 14px; color: #9ca3af; }
      label { display: block; font-size: 13px; margin-top: 10px; margin-bottom: 4px; color: #e5e7eb; }
      input[type="text"] { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #4b5563; background: #020617; color: #e5e7eb; font-size: 14px; }
      button { margin-top: 12px; padding: 8px 14px; border-radius: 999px; border: none; background: #22c55e; color: #022c22; font-weight: 600; font-size: 14px; cursor: pointer; }
      button:disabled { opacity: .6; cursor: default; }
      .qr-wrap { margin-top: 14px; display: flex; align-items: center; justify-content: center; }
      .qr-wrap img { border-radius: 8px; border: 1px solid rgba(75,85,99,0.8); background: white; }
      .status { margin-top: 10px; font-size: 13px; color: #9ca3af; }
      .payload { margin-top: 6px; font-size: 11px; color: #6b7280; word-break: break-all; }
      a { color: #38bdf8; text-decoration: none; }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="card">
        <h1>Shamell · Device login</h1>
        <p>Scan this code with Shamell on your phone (Scan &gt; Scan QR). Confirm the login on the phone to sign in this browser.</p>
        <label for="dl_label">Device label (optional)</label>
        <input id="dl_label" type="text" value="Web" autocomplete="off" />
        <button id="dl_btn" type="button">Start new login QR</button>
        <div class="qr-wrap">
          <img id="dl_qr_img" src="" alt="Device login QR" width="220" height="220" />
        </div>
        <div id="dl_status" class="status">No active login yet.</div>
        <div id="dl_payload" class="payload"></div>
      </div>
    </div>
    <script>
      let dlToken = null;
      let dlPollTimer = null;

      async function dlStart() {
        const btn = document.getElementById('dl_btn');
        const labEl = document.getElementById('dl_label');
        const statusEl = document.getElementById('dl_status');
        const payloadEl = document.getElementById('dl_payload');
        const img = document.getElementById('dl_qr_img');
        const label = (labEl.value || '').trim();
        btn.disabled = true;
        statusEl.textContent = 'Requesting login token…';
        payloadEl.textContent = '';
        if (dlPollTimer) {
          clearInterval(dlPollTimer);
          dlPollTimer = null;
        }
        try {
          const resp = await fetch('/auth/device_login/start', {
            method: 'POST',
            headers: {'content-type': 'application/json'},
            body: JSON.stringify({label: label || null})
          });
          const data = await resp.json();
          if (!resp.ok || !data.token) {
            statusEl.textContent = 'Failed to start device login.';
            btn.disabled = false;
            return;
          }
          dlToken = data.token;
          const url = new URL(window.location.href);
          const base = url.origin || '';
          const payload = 'shamell://device_login?token=' + encodeURIComponent(dlToken) + (label ? '&label=' + encodeURIComponent(label) : '');
          // Never send login tokens to third-party QR generators.
          img.src = '/qr.png?box_size=6&border=2&data=' + encodeURIComponent(payload) + '&ts=' + Date.now();
          img.alt = 'Device login QR';
          statusEl.textContent = 'Waiting for scan and approval on phone…';
          payloadEl.textContent = payload;
          dlPollTimer = setInterval(dlPoll, 2000);
        } catch (e) {
          console.error(e);
          statusEl.textContent = 'Failed to start device login.';
        } finally {
          btn.disabled = false;
        }
      }

      async function dlPoll() {
        if (!dlToken) return;
        const statusEl = document.getElementById('dl_status');
        try {
          const resp = await fetch('/auth/device_login/redeem', {
            method: 'POST',
            headers: {'content-type': 'application/json'},
            body: JSON.stringify({token: dlToken})
          });
          if (!resp.ok) {
            let detail = '';
            try {
              const err = await resp.json();
              detail = (err && err.detail) || '';
            } catch (_) {}
            if (detail && (detail.indexOf('expired') !== -1 || detail.indexOf('not found') !== -1)) {
              statusEl.textContent = 'Login token expired. Start a new QR.';
              clearInterval(dlPollTimer);
              dlPollTimer = null;
              dlToken = null;
            }
            return;
          }
          const data = await resp.json();
          const phone = (data && data.phone) || '';
          statusEl.textContent = phone ? ('Login successful for ' + phone + '. This browser is now signed in.') : 'Login successful.';
          clearInterval(dlPollTimer);
          dlPollTimer = null;
        } catch (e) {
          console.error(e);
        }
      }

      document.getElementById('dl_btn').addEventListener('click', dlStart);
    </script>
  </body>
</html>

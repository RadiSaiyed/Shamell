<!doctype html>
<html><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moments Comments Admin</title>
  <style>
    body{font-family:sans-serif;margin:20px;max-width:960px;color:#0f172a;}
    h1{margin-bottom:8px;}
    table{border-collapse:collapse;width:100%;margin-top:12px;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;font-size:13px;text-align:left;vertical-align:top;}
    th{background:#f9fafb;font-weight:600;}
    pre{white-space:pre-wrap;font-family:ui-monospace,monospace;font-size:12px;margin:0;}
    .meta{color:#6b7280;font-size:12px;margin-top:4px;}
    .row-actions{white-space:nowrap;}
    input{font-size:13px;padding:4px 6px;margin:2px 0;}
    button{font-size:13px;padding:4px 8px;margin:0 2px;cursor:pointer;}
    .error{color:#b91c1c;margin-top:4px;}
    .success{color:#166534;margin-top:4px;}
  </style>
</head><body>
  <h1>Moments Comments</h1>
  <div class="meta">QA/Moderation for comments. Filter by post ID and delete problematic comments.</div>

  <div>
    <label>Post ID:
      <input id="post_id" type="number" placeholder="optional: filter by post" />
    </label>
    <label>Official account ID:
      <input id="official_id" type="text" placeholder="optional: filter by official" />
    </label>
    <label>Limit:
      <input id="limit" type="number" value="100" min="1" max="500" />
    </label>
    <button onclick="loadComments()">Load</button>
  </div>
  <div class="meta" style="margin-top:4px;">
    Reply as Official:
    <select id="reply_official">
      <option value="">– select account –</option>
    </select>
    <button onclick="reloadOfficials()">Reload accounts</button>
  </div>
  <div id="flash" class="meta"></div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Post</th>
        <th>User</th>
        <th>Created</th>
        <th>Reply&nbsp;to</th>
        <th>Text</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="comments-body">
      <tr><td colspan="7">Use the filter above and click Load.</td></tr>
    </tbody>
  </table>

  <script>
    function getInitialPostId() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        return params.get('post_id') || '';
      } catch (e) {
        return '';
      }
    }

    function getInitialOfficialId() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        return params.get('official_account_id') || '';
      } catch (e) {
        return '';
      }
    }

    async function loadComments() {
      const bodyEl = document.getElementById('comments-body');
      const flash = document.getElementById('flash');
      flash.textContent = '';
      const postId = document.getElementById('post_id').value.trim();
       const officialIdInput = document.getElementById('official_id');
      const officialId = officialIdInput ? officialIdInput.value.trim() : '';
      const limitEl = document.getElementById('limit');
      let limit = parseInt(limitEl.value || '100', 10);
      if (!Number.isFinite(limit) || limit <= 0) limit = 100;
      let url = '/moments/admin/comments?limit=' + encodeURIComponent(String(limit));
      if (postId) {
        url += '&post_id=' + encodeURIComponent(postId);
      }
      if (officialId) {
        url += '&official_account_id=' + encodeURIComponent(officialId);
      }
      try {
        const r = await fetch(url);
        if (!r.ok) {
          bodyEl.innerHTML = '<tr><td colspan="7">Fehler beim Laden: ' + r.status + '</td></tr>';
          return;
        }
        const data = await r.json();
        const items = data.items || [];
        if (!items.length) {
          bodyEl.innerHTML = '<tr><td colspan="7">Keine Kommentare gefunden.</td></tr>';
          return;
        }
        bodyEl.innerHTML = '';
        for (const c of items) {
          const tr = document.createElement('tr');
          const text = (c.text || '').toString();
          const short = text.length > 260 ? text.slice(0, 260) + '…' : text;
          const rawUser = (c.user_key || '').toString();
          let userLabel = rawUser;
          if (rawUser.startsWith('official:')) {
            userLabel = 'Official · ' + rawUser.slice('official:'.length);
          }
          tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.post_id}</td>
            <td><pre>${userLabel.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre></td>
            <td><span class="meta">${c.created_at || ''}</span></td>
            <td>${c.reply_to_id != null ? c.reply_to_id : ''}</td>
            <td><pre>${short.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre></td>
            <td class="row-actions">
              <button onclick="replyToComment(${c.id}, ${c.post_id})">Reply as official</button>
              <button onclick="deleteComment(${c.id})">Delete</button>
            </td>
          `;
          bodyEl.appendChild(tr);
        }
      } catch (e) {
        bodyEl.innerHTML = '<tr><td colspan="7">Fehler: ' + e + '</td></tr>';
      }
    }

    async function deleteComment(id) {
      if (!id && id !== 0) return;
      const flash = document.getElementById('flash');
      flash.textContent = '';
      try {
        const r = await fetch('/moments/admin/comments/' + encodeURIComponent(String(id)), {
          method: 'DELETE',
        });
        if (!r.ok) {
          const txt = await r.text();
          flash.textContent = 'Fehler beim Löschen: ' + r.status + ' ' + txt;
          flash.className = 'error';
        } else {
          flash.textContent = 'Kommentar gelöscht.';
          flash.className = 'success';
          loadComments();
        }
      } catch (e) {
        flash.textContent = 'Fehler: ' + e;
        flash.className = 'error';
      }
    }

    async function reloadOfficials() {
      const sel = document.getElementById('reply_official');
      if (!sel) return;
      sel.innerHTML = '<option value=\"\">…loading…</option>';
      try {
        const r = await fetch('/admin/official_accounts');
        if (!r.ok) {
          sel.innerHTML = '<option value=\"\">(error)</option>';
          return;
        }
        const data = await r.json();
        const items = data.accounts || [];
        if (!items.length) {
          sel.innerHTML = '<option value=\"\">(no accounts)</option>';
          return;
        }
        sel.innerHTML = '<option value=\"\">– select account –</option>';
        for (const acc of items) {
          const opt = document.createElement('option');
          opt.value = acc.id;
          opt.textContent = acc.id + ' – ' + (acc.name || '');
          sel.appendChild(opt);
        }
      } catch (e) {
        sel.innerHTML = '<option value=\"\">(error)</option>';
      }
    }

    async function replyToComment(id, postId) {
      const flash = document.getElementById('flash');
      flash.textContent = '';
      const sel = document.getElementById('reply_official');
      if (!sel) {
        flash.textContent = 'No official account selector.';
        flash.className = 'error';
        return;
      }
      const accId = sel.value.trim();
      if (!accId) {
        flash.textContent = 'Bitte Official-Account auswählen.';
        flash.className = 'error';
        return;
      }
      const text = window.prompt('Reply text:');
      if (!text || !text.trim()) {
        return;
      }
      try {
        const payload = {
          text: text.trim(),
          official_account_id: accId,
          reply_to_id: id,
        };
        const r = await fetch('/moments/admin/posts/' + encodeURIComponent(String(postId)) + '/comment', {
          method: 'POST',
          headers: {'content-type':'application/json'},
          body: JSON.stringify(payload),
        });
        if (!r.ok) {
          const txt = await r.text();
          flash.textContent = 'Fehler beim Antworten: ' + r.status + ' ' + txt;
          flash.className = 'error';
        } else {
          flash.textContent = 'Antwort gesendet.';
          flash.className = 'success';
          loadComments();
        }
      } catch (e) {
        flash.textContent = 'Fehler: ' + e;
        flash.className = 'error';
      }
    }

    (function init() {
      const initialPost = getInitialPostId();
      const initialOfficial = getInitialOfficialId();
      reloadOfficials();
      if (initialPost) {
        const input = document.getElementById('post_id');
        if (input) input.value = initialPost;
        // ignore: discarded_futures
        loadComments();
      } else if (initialOfficial) {
        const input = document.getElementById('official_id');
        if (input) input.value = initialOfficial;
        // ignore: discarded_futures
        loadComments();
      }
    })();
  </script>
</body></html>

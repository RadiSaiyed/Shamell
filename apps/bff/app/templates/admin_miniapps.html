<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shamell · Mini-Apps</title>
    <style>
      body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 16px; max-width: 960px; color: #0f172a; background:#ffffff; }
      h1 { margin-bottom: 4px; }
      h2 { margin-top: 24px; margin-bottom: 8px; }
      table { border-collapse: collapse; width: 100%; margin-top: 8px; }
      th, td { border: 1px solid #e5e7eb; padding: 6px 8px; font-size: 13px; text-align: left; vertical-align: top; }
      th { background: #f9fafb; font-weight: 600; }
      input, select, textarea { font-size: 13px; padding: 4px 6px; margin: 2px 0; width: 100%; box-sizing: border-box; }
      textarea { min-height: 48px; }
      button { font-size: 13px; padding: 4px 8px; margin: 0 2px; cursor: pointer; }
      .pill { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; }
      .pill-official { background:#dbeafe; color:#1d4ed8; }
      .pill-beta { background:#fef3c7; color:#92400e; }
      .pill-disabled { background:#fee2e2; color:#991b1b; }
      .muted { color:#6b7280; font-size:12px; }
      .row-actions { white-space: nowrap; }
      .error { color:#b91c1c; margin-top:4px; }
      .success { color:#166534; margin-top:4px; }
      .flex { display:flex; gap:8px; flex-wrap:wrap; }
      .flex > div { flex:1 1 220px; min-width:200px; }
      code { font-size:12px; background:#f3f4f6; padding:2px 4px; border-radius:4px; }
    </style>
  </head>
  <body>
    <h1>Mini-Apps</h1>
    <p class="muted">
      WeChat-ähnliche Mini-Programme für das Shamell-Ökosystem.<br/>
      Diese Konsole steuert den Katalog unter <code>/mini_apps</code> und den Mini-Apps-Tab in der Super-App.
    </p>
    <p class="muted">
      <a href="/admin/officials">Official-Accounts-Konsole</a>
      · <a href="/admin/redpacket_campaigns/analytics">Red‑Packet‑Kampagnen-Analytics</a>
      · <a href="/admin/miniapps/analytics">Mini‑Apps‑Analytics</a>
    </p>

    <div id="flash" class="muted"></div>

    <h2>Bestehende Mini-Apps</h2>
    <p class="muted">Status, Rating und Usage-Scores dienen als einfache Trending-Signale (analog zu WeChat Popular Mini-Programs).</p>
    <table id="miniapps-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Kategorie</th>
          <th>Runtime</th>
          <th>Status</th>
          <th>Rating</th>
          <th>Usage</th>
          <th>Beschreibung</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="miniapps-body">
        <tr><td colspan="9">Lade Daten…</td></tr>
      </tbody>
    </table>

    <h2>Neue Mini-App registrieren</h2>
    <div class="flex">
      <div>
        <label>App-ID<br/>
          <input id="new_app_id" placeholder="z.B. partner_shop" />
        </label>
      </div>
      <div>
        <label>Titel (EN)<br/>
          <input id="new_title_en" placeholder="Display title (EN)" />
        </label>
      </div>
      <div>
        <label>Titel (AR, optional)<br/>
          <input id="new_title_ar" placeholder="Display title (AR)" />
        </label>
      </div>
    </div>
    <div class="flex">
      <div>
        <label>Kategorie (EN)<br/>
          <input id="new_category_en" placeholder="z.B. Mobility, Marketplace" />
        </label>
      </div>
      <div>
        <label>Kategorie (AR)<br/>
          <input id="new_category_ar" placeholder="optional (AR)" />
        </label>
      </div>
      <div>
        <label>Icon (optional)<br/>
          <input id="new_icon" placeholder="Material-Icon-Name oder custom key" />
        </label>
      </div>
    </div>
    <div class="flex">
      <div>
        <label>Runtime-App-ID (optional, Mini‑Program)<br/>
          <input id="new_runtime_app_id" placeholder="z.B. demo_program (Mini-Program app_id)" />
        </label>
      </div>
      <div></div>
      <div></div>
    </div>
    <div class="flex">
      <div>
        <label>Beschreibung<br/>
          <textarea id="new_description" placeholder="Kurzbeschreibung (z.B. Partner-Shop oder Service)"></textarea>
        </label>
      </div>
      <div>
        <label><input type="checkbox" id="new_official" /> Official (Shamell-first-party)</label><br/>
        <label><input type="checkbox" id="new_beta" /> Beta</label><br/>
        <label><input type="checkbox" id="new_enabled" checked /> Enabled</label>
      </div>
      <div>
        <label>Rating (0–5, optional)<br/>
          <input id="new_rating" placeholder="z.B. 4.5" />
        </label>
        <label>Usage-Score (optional)<br/>
          <input id="new_usage" placeholder="z.B. 50" />
        </label>
      </div>
    </div>
    <p>
      <button onclick="createMiniApp()">Mini-App registrieren</button>
    </p>

    <script>
      async function loadMiniApps() {
        const bodyEl = document.getElementById('miniapps-body');
        const flash = document.getElementById('flash');
        flash.textContent = '';
        try {
          const r = await fetch('/admin/mini_apps');
          if (!r.ok) {
            bodyEl.innerHTML = '<tr><td colspan="9">Fehler beim Laden: ' + r.status + '</td></tr>';
            return;
          }
          const data = await r.json();
          const items = data.apps || [];
          if (!items.length) {
            bodyEl.innerHTML = '<tr><td colspan="9">Noch keine Mini-Apps registriert.</td></tr>';
            return;
          }
          bodyEl.innerHTML = '';
          for (const app of items) {
            const tr = document.createElement('tr');
            const statusHtml = [
              app.enabled ? '' : '<span class="pill pill-disabled">disabled</span>',
              app.official ? '<span class="pill pill-official">official</span>' : '',
              app.beta ? '<span class="pill pill-beta">beta</span>' : '',
            ].filter(Boolean).join(' ');
            const rating = (app.rating != null ? app.rating : 0).toFixed ? Number(app.rating).toFixed(1) : String(app.rating || '');
            const usage = app.usage_score != null ? String(app.usage_score) : '';
            const cat = [app.category_en || '', app.category_ar || ''].filter(Boolean).join(' / ');
            const runtime = app.runtime_app_id || '';
            tr.innerHTML = `
              <td><code>${app.app_id || ''}</code></td>
              <td>${app.title_en || ''}<br/><span class="muted">${app.title_ar || ''}</span></td>
              <td>${cat}</td>
              <td>${runtime ? '<code>' + runtime + '</code>' : '<span class="muted">–</span>'}</td>
              <td>${statusHtml || '<span class="muted">–</span>'}</td>
              <td>${rating || ''}</td>
              <td>${usage || ''}</td>
              <td>${app.description || ''}</td>
              <td class="row-actions">
                <button onclick="toggleMiniAppEnabled('${app.app_id}', ${app.enabled ? 'false' : 'true'})">${app.enabled ? 'Disable' : 'Enable'}</button>
                <button onclick="toggleMiniAppOfficial('${app.app_id}', ${app.official ? 'false' : 'true'})">${app.official ? 'Set partner' : 'Set official'}</button>
                <button onclick="editMiniApp('${app.app_id}')">Edit</button>
              </td>
            `;
            tr.dataset.appId = app.app_id || '';
            tr.dataset.titleEn = app.title_en || '';
            tr.dataset.titleAr = app.title_ar || '';
            tr.dataset.categoryEn = app.category_en || '';
            tr.dataset.categoryAr = app.category_ar || '';
            tr.dataset.description = app.description || '';
            tr.dataset.icon = app.icon || '';
            tr.dataset.runtimeAppId = app.runtime_app_id || '';
            tr.dataset.official = app.official ? 'true' : 'false';
            tr.dataset.enabled = app.enabled ? 'true' : 'false';
            tr.dataset.beta = app.beta ? 'true' : 'false';
            tr.dataset.rating = rating || '';
            tr.dataset.usage = usage || '';
            bodyEl.appendChild(tr);
          }
        } catch (e) {
          bodyEl.innerHTML = '<tr><td colspan="8">Fehler: ' + e + '</td></tr>';
        }
      }

      async function patchMiniApp(appId, patch) {
        const flash = document.getElementById('flash');
        flash.textContent = '';
        try {
          const r = await fetch('/admin/mini_apps/' + encodeURIComponent(appId), {
            method: 'PATCH',
            headers: {'content-type':'application/json'},
            body: JSON.stringify(patch),
          });
          if (!r.ok) {
            const txt = await r.text();
            flash.textContent = 'Fehler: ' + r.status + ' ' + txt;
            flash.className = 'error';
          } else {
            flash.textContent = 'Gespeichert.';
            flash.className = 'success';
            loadMiniApps();
          }
        } catch (e) {
          flash.textContent = 'Fehler: ' + e;
          flash.className = 'error';
        }
      }

      function toggleMiniAppEnabled(appId, enabled) {
        patchMiniApp(appId, {enabled: !!enabled});
      }

      function toggleMiniAppOfficial(appId, official) {
        patchMiniApp(appId, {official: !!official});
      }

      function editMiniApp(appId) {
        const bodyEl = document.getElementById('miniapps-body');
        const rows = bodyEl.querySelectorAll('tr');
        for (const tr of rows) {
          if (!tr.dataset) continue;
          if (tr.dataset.appId === String(appId)) {
            document.getElementById('new_app_id').value = tr.dataset.appId || '';
            document.getElementById('new_title_en').value = tr.dataset.titleEn || '';
            document.getElementById('new_title_ar').value = tr.dataset.titleAr || '';
            document.getElementById('new_category_en').value = tr.dataset.categoryEn || '';
            document.getElementById('new_category_ar').value = tr.dataset.categoryAr || '';
            document.getElementById('new_description').value = tr.dataset.description || '';
            document.getElementById('new_icon').value = tr.dataset.icon || '';
            document.getElementById('new_runtime_app_id').value = tr.dataset.runtimeAppId || '';
            document.getElementById('new_official').checked = (tr.dataset.official === 'true');
            document.getElementById('new_enabled').checked = (tr.dataset.enabled === 'true');
            document.getElementById('new_beta').checked = (tr.dataset.beta === 'true');
            document.getElementById('new_rating').value = tr.dataset.rating || '';
            document.getElementById('new_usage').value = tr.dataset.usage || '';
            break;
          }
        }
      }

      async function createMiniApp() {
        const flash = document.getElementById('flash');
        flash.textContent = '';
        const app_id = document.getElementById('new_app_id').value.trim();
        const title_en = document.getElementById('new_title_en').value.trim();
        const title_ar = document.getElementById('new_title_ar').value.trim();
        const category_en = document.getElementById('new_category_en').value.trim();
        const category_ar = document.getElementById('new_category_ar').value.trim();
        const description = document.getElementById('new_description').value.trim();
        const icon = document.getElementById('new_icon').value.trim();
        const official = document.getElementById('new_official').checked;
        const beta = document.getElementById('new_beta').checked;
        const enabled = document.getElementById('new_enabled').checked;
        const ratingStr = document.getElementById('new_rating').value.trim();
        const usageStr = document.getElementById('new_usage').value.trim();
        const runtimeAppId = document.getElementById('new_runtime_app_id').value.trim();
        if (!app_id || !title_en) {
          flash.textContent = 'App-ID und Titel (EN) sind Pflicht.';
          flash.className = 'error';
          return;
        }
        const payload = {
          app_id,
          title_en,
          title_ar: title_ar || null,
          category_en: category_en || null,
          category_ar: category_ar || null,
          description: description || null,
          icon: icon || null,
          official,
          beta,
          enabled,
          runtime_app_id: runtimeAppId || null,
        };
        if (ratingStr) {
          const v = Number(ratingStr.replace(',', '.'));
          if (!Number.isNaN(v)) {
            payload.rating = v;
          }
        }
        if (usageStr) {
          const v = Number(usageStr);
          if (!Number.isNaN(v)) {
            payload.usage_score = Math.trunc(v);
          }
        }
        try {
          const r = await fetch('/admin/mini_apps', {
            method: 'POST',
            headers: {'content-type':'application/json'},
            body: JSON.stringify(payload),
          });
          if (!r.ok) {
            const txt = await r.text();
            flash.textContent = 'Fehler: ' + r.status + ' ' + txt;
            flash.className = 'error';
          } else {
            flash.textContent = 'Mini-App registriert.';
            flash.className = 'success';
            document.getElementById('new_app_id').value = '';
            document.getElementById('new_title_en').value = '';
            document.getElementById('new_title_ar').value = '';
            document.getElementById('new_category_en').value = '';
            document.getElementById('new_category_ar').value = '';
            document.getElementById('new_description').value = '';
            document.getElementById('new_icon').value = '';
            document.getElementById('new_official').checked = false;
            document.getElementById('new_beta').checked = false;
            document.getElementById('new_enabled').checked = true;
            document.getElementById('new_rating').value = '';
            document.getElementById('new_usage').value = '';
            document.getElementById('new_runtime_app_id').value = '';
            loadMiniApps();
          }
        } catch (e) {
          flash.textContent = 'Fehler: ' + e;
          flash.className = 'error';
        }
      }

      loadMiniApps();
    </script>
  </body>
</html>

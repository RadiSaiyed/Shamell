<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Courier Tracking</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --accent: #22d3ee;
      --card: #111827;
      --muted: #94a3b8;
    }
    body { margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--fg); }
    header { padding:16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .logo { width:36px; height:36px; border-radius:10px; background: linear-gradient(135deg,#22d3ee,#0ea5e9); display:flex; align-items:center; justify-content:center; font-weight:700; color:#0b1220; }
    .brand { font-size:14px; color: var(--muted); }
    .card { background: var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:14px; margin:12px 16px; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
    h2 { margin:0 0 8px 0; font-size:18px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, textarea, select { background: #0b1220; color: var(--fg); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:8px 10px; }
    button { background: var(--accent); color:#0b1220; border: none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:0 10px 30px rgba(34,211,238,0.3); }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .badge { display:inline-flex; align-items:center; gap:6px; background: rgba(34,211,238,0.1); color: var(--accent); padding:6px 10px; border-radius:999px; font-size:12px; }
    .status { font-weight:700; }
    .timeline { list-style:none; padding:0; margin:0; }
    .timeline li { padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
    .muted { color: var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="logo" id="logo">CO</div>
    <div>
      <div id="brandName">Courier</div>
      <div class="brand" id="brandText">Premium delivery</div>
    </div>
    <div style="flex:1"></div>
    <div class="badge" id="statusBadge">status: —</div>
  </header>

  <div class="card">
    <h2>Tracking</h2>
    <div class="row">
      <input id="tok" placeholder="Tracking token or order ID" style="flex:1" />
      <button onclick="loadTrack()">Track</button>
    </div>
    <div style="margin-top:10px" class="muted">ETA: <span id="eta">—</span> · Window: <span id="window">—</span> · Driver: <span id="driver">—</span></div>
    <div style="margin-top:10px" id="address" class="muted">Address: —</div>
  </div>

  <div class="card">
    <h2>Contact & Reschedule</h2>
    <div class="row" style="margin-bottom:8px">
      <textarea id="msg" placeholder="Message to support" style="flex:1"></textarea>
      <button onclick="contact()">Send</button>
    </div>
    <div class="row">
      <input id="ws" type="datetime-local" />
      <input id="we" type="datetime-local" />
      <label class="muted"><input type="checkbox" id="sts" /> Short-term storage</label>
      <button onclick="resched()">Reschedule</button>
    </div>
    <div id="contactOut" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h2>Events</h2>
    <ul class="timeline" id="events"></ul>
  </div>

  <script>
    async function loadTrack(){
      const t=document.getElementById('tok').value.trim();
      if(!t){ alert('enter token or id'); return; }
      let r=await fetch('/courier/track/'+encodeURIComponent(t)).then(x=>x);
      if(r.status===404){
        r=await fetch('/courier/shipments/'+encodeURIComponent(t));
      }
      const j=await r.json();
      renderTrack(j);
    }
    function renderTrack(j){
      document.getElementById('statusBadge').textContent='status: '+(j.status||'');
      document.getElementById('eta').textContent=j.eta_ts||'—';
      const ws=j.window_start||'', we=j.window_end||'';
      document.getElementById('window').textContent=(ws&&we)?(ws+' → '+we):'—';
      document.getElementById('driver').textContent=(j.driver_name||'')+(j.driver_phone?(' · '+j.driver_phone):'');
      document.getElementById('address').textContent='Address: '+(j.drop_address||j.validated_address||'—');
      if(j.partner_name){
        document.getElementById('brandName').textContent=j.partner_name;
      }
      if(j.partner_brand_text){
        document.getElementById('brandText').textContent=j.partner_brand_text;
      }
      const ev=document.getElementById('events'); ev.innerHTML='';
      (j.events||[]).forEach(e=>{
        const li=document.createElement('li');
        li.innerHTML=`<div><span class="status">${e.status}</span> <span class="muted">${e.created_at||''}</span></div><div class="muted">${e.note||''}</div>`;
        ev.appendChild(li);
      });
      // remember order id for contact/resched
      window._lastOrderId = j.id;
    }
    async function contact(){
      const oid=window._lastOrderId || document.getElementById('tok').value.trim();
      const msg=document.getElementById('msg').value;
      if(!oid||!msg){ alert('order id and message required'); return; }
      const r=await fetch('/courier/orders/'+encodeURIComponent(oid)+'/contact',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({message:msg})});
      document.getElementById('contactOut').textContent=await r.text();
    }
    async function resched(){
      const oid=window._lastOrderId || document.getElementById('tok').value.trim();
      const ws=document.getElementById('ws').value;
      const we=document.getElementById('we').value;
      if(!oid||!ws||!we){ alert('order id and windows required'); return; }
      const body={window_start:ws, window_end:we, short_term_storage:document.getElementById('sts').checked};
      const r=await fetch('/courier/orders/'+encodeURIComponent(oid)+'/reschedule',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
      document.getElementById('contactOut').textContent=await r.text();
    }
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Courier SLA</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;background:#0b1220;color:#e2e8f0;}
    header{padding:16px;border-bottom:1px solid rgba(255,255,255,0.08);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
    .card{background:#111827;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px;}
    .label{font-size:12px;color:#94a3b8;}
    .value{font-size:24px;font-weight:700;}
    input,select{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0b1220;color:#e2e8f0;}
    button{padding:10px 14px;border:none;border-radius:10px;background:#22d3ee;color:#0b1220;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(34,211,238,0.3);}
    ul{list-style:none;padding:0;margin:0;}
    li{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
    canvas{background:#0b1220;border-radius:12px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="carrier" placeholder="Carrier" />
      <input id="partner" placeholder="Partner ID" />
      <select id="svc">
        <option value="">any</option>
        <option value="same_day">same_day</option>
        <option value="next_day">next_day</option>
      </select>
      <button onclick="load()">Refresh</button>
    </div>
  </header>
  <div class="card" style="margin:12px">
    <div class="grid" id="statCards"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="downloadStats()">Download stats CSV</button>
      <button onclick="downloadKPI()">Download partner KPIs CSV</button>
    </div>
  </div>
  <div class="card" style="margin:12px">
    <h3>On-promise rate</h3>
    <canvas id="chart" width="400" height="200"></canvas>
  </div>
  <div class="card" style="margin:12px">
    <h3>Partner KPIs</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input id="start" type="datetime-local" />
      <input id="end" type="datetime-local" />
      <button onclick="load()">Reload</button>
    </div>
    <ul id="kpiList"></ul>
  </div>
  <script>
    async function load(){
      const params=new URLSearchParams();
      const c=document.getElementById('carrier').value;
      const p=document.getElementById('partner').value;
      const svc=document.getElementById('svc').value;
      if(c)params.set('carrier',c); if(p)params.set('partner_id',p); if(svc)params.set('service_type',svc);
      const stat=await fetch('/courier/stats?'+params.toString()).then(r=>r.json());
      renderStats(stat);
      const kparams=new URLSearchParams(params);
      const s=document.getElementById('start').value; const e=document.getElementById('end').value;
      if(s)kparams.set('start_iso',s); if(e)kparams.set('end_iso',e);
      const kpis=await fetch('/courier/kpis/partners?'+kparams.toString()).then(r=>r.json());
      renderKpis(kpis);
    }
    function renderStats(s){
      const cards=document.getElementById('statCards'); cards.innerHTML='';
      const items=[
        {label:'Total', value:s.total},
        {label:'Delivered', value:s.delivered},
        {label:'On-promise', value:s.on_promise, extra: s.on_promise_rate?`${Math.round(s.on_promise_rate*100)}%`:''},
        {label:'Returns', value:s.return_required},
        {label:'Avg dist km', value:(s.avg_distance_km||0).toFixed(2)},
        {label:'Avg CO₂ g', value:(s.avg_co2_grams||0).toFixed(1)},
        {label:'Total CO₂ g', value:s.total_co2_grams||0},
        {label:'Avg driver batt', value: s.avg_driver_battery?`${s.avg_driver_battery.toFixed(0)}%`:'—'},
      ];
      for(const it of items){
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`<div class="label">${it.label}</div><div class="value">${it.value??'—'}</div><div class="label">${it.extra||''}</div>`;
        cards.appendChild(div);
      }
      drawChart(s.on_promise_rate||0, s.return_required||0, s.slots||{});
    }
    function renderKpis(kpis){
      const ul=document.getElementById('kpiList'); ul.innerHTML='';
      (kpis||[]).forEach(k=>{
        const li=document.createElement('li');
        li.innerHTML=`<div><strong>${k.partner_id||'—'}</strong> · total ${k.total} · delivered ${k.delivered}</div><div class="label">On-promise ${Math.round((k.on_promise_rate||0)*100)}% · returns ${k.return_required}</div>`;
        ul.appendChild(li);
      });
    }
    let chart;
    function drawChart(onPromiseRate, returns, slots){
      const labels=['On-promise %','Returns'];
      const data=[Math.round(onPromiseRate*100), returns];
      const slotLabels=Object.keys(slots||{}).sort();
      const slotData=slotLabels.map(k=>Math.round((slots[k]||0)*100));
      const ctx=document.getElementById('chart').getContext('2d');
      if(chart){ chart.destroy(); }
      chart=new Chart(ctx,{
        type:'bar',
        data:{
          labels: labels.concat(slotLabels.map(l=>`Slot ${l}`)),
          datasets:[{
            label:'SLA',
            data: data.concat(slotData),
            backgroundColor: [...Array(data.length).fill('#22d3ee'), ...slotData.map(()=> '#0ea5e9')],
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true,max:100}}
        }
      });
    }
    load();
  </script>
  <script>
    function downloadStats(){
      const params=new URLSearchParams();
      const c=document.getElementById('carrier').value;
      const p=document.getElementById('partner').value;
      const svc=document.getElementById('svc').value;
      if(c)params.set('carrier',c); if(p)params.set('partner_id',p); if(svc)params.set('service_type',svc);
      window.location.href='/courier/stats/export?'+params.toString();
    }
    function downloadKPI(){
      const params=new URLSearchParams();
      const c=document.getElementById('carrier').value;
      const p=document.getElementById('partner').value;
      const svc=document.getElementById('svc').value;
      const s=document.getElementById('start').value; const e=document.getElementById('end').value;
      if(c)params.set('carrier',c); if(p)params.set('partner_id',p); if(svc)params.set('service_type',svc); if(s)params.set('start_iso',s); if(e)params.set('end_iso',e);
      window.location.href='/courier/kpis/partners/export?'+params.toString();
    }
  </script>
</body>
</html>

x-core-build: &core_build
  context: .
  dockerfile: apps/monolith/Dockerfile

services:
  bootstrap-perms:
    image: alpine:3.19
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
    read_only: true
    tmpfs:
      - /tmp
    network_mode: none
    command:
      - /bin/sh
      - -ceu
      - |
        uid=10001
        gid=10001
        d="/vol/monolith_data"
        [ -d "$$d" ] || exit 0
        owner="$$(stat -c '%u:%g' "$$d" 2>/dev/null || true)"
        if [ "$$owner" != "$$uid:$$gid" ]; then
          echo "Fixing ownership: $$d -> $${uid}:$${gid} (was $${owner:-unknown})" >&2
          chown -R "$${uid}:$${gid}" "$$d"
        fi
    volumes:
      - monolith_data:/vol/monolith_data

  monolith:
    build: *core_build
    image: shamell-core:devmono
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    environment:
      ENV: "dev"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      MONOLITH_MODE: "1"
      MONOLITH_ONLY: "1"
      MONOLITH_DB_URL: "sqlite+pysqlite:////data/monolith.db"
      PAYMENTS_DB_URL: "sqlite+pysqlite:////data/payments.db"
      DB_URL: "sqlite+pysqlite:////data/core.db"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:-}"
      PAYMENTS_INTERNAL_SECRET: "${PAYMENTS_INTERNAL_SECRET:-}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
      CSRF_GUARD_ENABLED: "${CSRF_GUARD_ENABLED:-false}"
      RATE_STORE_MAX_KEYS: "${RATE_STORE_MAX_KEYS:-20000}"
      # LiveKit (dev defaults)
      LIVEKIT_URL: "${LIVEKIT_URL:-ws://livekit:7880}"
      LIVEKIT_PUBLIC_URL: "${LIVEKIT_PUBLIC_URL:-}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-}"
      LIVEKIT_TOKEN_ENDPOINT_ENABLED: "${LIVEKIT_TOKEN_ENDPOINT_ENABLED:-false}"
      LIVEKIT_TOKEN_TTL_SECS: "${LIVEKIT_TOKEN_TTL_SECS:-300}"
      LIVEKIT_TOKEN_MAX_TTL_SECS: "${LIVEKIT_TOKEN_MAX_TTL_SECS:-3600}"
      TRUST_PROXY_HEADERS: "${TRUST_PROXY_HEADERS:-off}"
      TRUST_PRIVATE_PROXY_HOPS: "${TRUST_PRIVATE_PROXY_HOPS:-true}"
      TRUSTED_PROXY_CIDRS: "${TRUSTED_PROXY_CIDRS:-}"
    volumes:
      - monolith_data:/data
    ports:
      - "127.0.0.1:8088:8080"
    command: ["uvicorn", "apps.monolith.app.main:app", "--host", "0.0.0.0", "--port", "8080"]
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.5.2
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./ops/livekit:/etc/livekit:ro
    ports:
      - "127.0.0.1:7880:7880"
      - "127.0.0.1:7881:7881"
      - "127.0.0.1:7882:7882/udp"
    restart: unless-stopped

volumes:
  monolith_data:

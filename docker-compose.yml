x-core-build: &core_build
  context: .
  dockerfile: apps/monolith/Dockerfile

services:
  bootstrap-perms:
    image: alpine:3.19
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
    read_only: true
    tmpfs:
      - /tmp
    network_mode: none
    command:
      - /bin/sh
      - -ceu
      - |
        uid=10001
        gid=10001
        for d in /vol/bff_data /vol/chat_data /vol/payments_data /vol/taxi_data; do
          [ -d "$$d" ] || continue
          owner="$$(stat -c '%u:%g' "$$d" 2>/dev/null || true)"
          if [ "$$owner" = "$$uid:$$gid" ]; then
            continue
          fi
          echo "Fixing ownership: $$d -> $${uid}:$${gid} (was $${owner:-unknown})" >&2
          chown -R "$${uid}:$${gid}" "$$d"
        done
    volumes:
      - bff_data:/vol/bff_data
      - chat_data:/vol/chat_data
      - payments_data:/vol/payments_data
      - taxi_data:/vol/taxi_data

  bff:
    build: *core_build
    image: shamell-core:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "dev"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
      CSRF_GUARD_ENABLED: "${CSRF_GUARD_ENABLED:-false}"
      RATE_STORE_MAX_KEYS: "${RATE_STORE_MAX_KEYS:-20000}"
      DB_URL: "sqlite+pysqlite:////data/core.db"
      MOMENTS_DB_URL: "sqlite+pysqlite:////data/moments.db"
      FRIENDS_DB_URL: "sqlite+pysqlite:////data/friends.db"
      NEARBY_DB_URL: "sqlite+pysqlite:////data/nearby.db"
      STICKERS_DB_URL: "sqlite+pysqlite:////data/stickers.db"
      OFFICIALS_DB_URL: "sqlite+pysqlite:////data/officials.db"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      PAYMENTS_INTERNAL_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      CHAT_BASE_URL: "http://chat:8081"
      PAYMENTS_BASE_URL: "http://payments:8082"
      TAXI_BASE_URL: "http://taxi:8083"
      TAXI_INTERNAL_SECRET: "${TAXI_INTERNAL_SECRET:-}"
      # LiveKit (dev defaults)
      LIVEKIT_URL: "${LIVEKIT_URL:-ws://livekit:7880}"
      LIVEKIT_PUBLIC_URL: "${LIVEKIT_PUBLIC_URL:-}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-}"
      LIVEKIT_TOKEN_ENDPOINT_ENABLED: "${LIVEKIT_TOKEN_ENDPOINT_ENABLED:-false}"
      LIVEKIT_TOKEN_TTL_SECS: "${LIVEKIT_TOKEN_TTL_SECS:-300}"
      LIVEKIT_TOKEN_MAX_TTL_SECS: "${LIVEKIT_TOKEN_MAX_TTL_SECS:-3600}"
      LIVEKIT_TOKEN_RATE_WINDOW_SECS: "${LIVEKIT_TOKEN_RATE_WINDOW_SECS:-60}"
      LIVEKIT_TOKEN_MAX_PER_PHONE: "${LIVEKIT_TOKEN_MAX_PER_PHONE:-30}"
      LIVEKIT_TOKEN_MAX_PER_IP: "${LIVEKIT_TOKEN_MAX_PER_IP:-80}"
      TRUST_PROXY_HEADERS: "${TRUST_PROXY_HEADERS:-off}"
      TRUST_PRIVATE_PROXY_HOPS: "${TRUST_PRIVATE_PROXY_HOPS:-true}"
      TRUSTED_PROXY_CIDRS: "${TRUSTED_PROXY_CIDRS:-}"
      PUSH_ALLOWED_HOSTS: "${PUSH_ALLOWED_HOSTS:-}"
      PUSH_ALLOW_HTTP: "${PUSH_ALLOW_HTTP:-false}"
      PUSH_ALLOW_PRIVATE_IPS: "${PUSH_ALLOW_PRIVATE_IPS:-false}"
      PUSH_VALIDATE_DNS: "${PUSH_VALIDATE_DNS:-true}"
      PUSH_MAX_ENDPOINT_LEN: "${PUSH_MAX_ENDPOINT_LEN:-2048}"
    volumes:
      - bff_data:/data
    ports:
      - "127.0.0.1:8080:8080"
    command: ["uvicorn", "apps.bff.app.main:app", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
      chat:
        condition: service_healthy
      payments:
        condition: service_healthy
      taxi:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  chat:
    image: shamell-core:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    environment:
      ENV: "dev"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      DB_URL: "sqlite+pysqlite:////data/chat.db"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      CHAT_REQUIRE_INTERNAL_SECRET: "true"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - chat_data:/data
    ports:
      - "127.0.0.1:8081:8081"
    command: ["uvicorn", "apps.chat.app.main:app", "--host", "0.0.0.0", "--port", "8081"]
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  payments:
    image: shamell-core:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
    environment:
      ENV: "dev"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      PAYMENTS_DB_URL: "sqlite+pysqlite:////data/payments.db"
      AUTO_CREATE_SCHEMA: "true"
      RUN_ALEMBIC_ON_STARTUP: "false"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      PAYMENTS_REQUIRE_INTERNAL_SECRET: "true"
      SONIC_SECRET: "${SONIC_SECRET:-dev-sonic-secret}"
      TOPUP_SECRET: "${TOPUP_SECRET:-dev-topup-secret}"
      ALIAS_CODE_PEPPER: "${ALIAS_CODE_PEPPER:-dev-alias-pepper}"
      CASH_SECRET_PEPPER: "${CASH_SECRET_PEPPER:-dev-cash-pepper}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - payments_data:/data
    ports:
      - "127.0.0.1:8082:8082"
    command: ["uvicorn", "apps.payments.app.main:app", "--host", "0.0.0.0", "--port", "8082"]
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8082/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  taxi:
    image: shamell-core:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      bootstrap-perms:
        condition: service_completed_successfully
      payments:
        condition: service_healthy
    environment:
      ENV: "dev"
      HOME: "/tmp"
      TMPDIR: "/tmp"
      XDG_CACHE_HOME: "/tmp/.cache"
      TAXI_DB_URL: "sqlite+pysqlite:////data/taxi.db"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      TAXI_INTERNAL_SECRET: "${TAXI_INTERNAL_SECRET:-}"
      # Taxi calls Payments as an internal client.
      PAYMENTS_BASE_URL: "http://payments:8082"
      PAYMENTS_INTERNAL_SECRET: "${INTERNAL_API_SECRET:?set INTERNAL_API_SECRET in .env}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173}"
    volumes:
      - taxi_data:/data
    command: ["uvicorn", "apps.taxi.app.main:app", "--host", "0.0.0.0", "--port", "8083"]
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8083/health', timeout=3).read()"
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.5.2
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./ops/livekit:/etc/livekit:ro
    ports:
      - "127.0.0.1:7880:7880"
      - "127.0.0.1:7881:7881"
      - "127.0.0.1:7882:7882/udp"
    restart: unless-stopped

volumes:
  bff_data:
  chat_data:
  payments_data:
  taxi_data:

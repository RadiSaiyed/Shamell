services:
  db:
    image: postgres:16-alpine
    init: true
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-shamell}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-shamell}"
      POSTGRES_DB: "${POSTGRES_DB:-postgres}"
      POSTGRES_DB_CORE: "${POSTGRES_DB_CORE:-shamell_core}"
      POSTGRES_DB_CHAT: "${POSTGRES_DB_CHAT:-shamell_chat}"
      POSTGRES_DB_PAYMENTS: "${POSTGRES_DB_PAYMENTS:-shamell_payments}"
      POSTGRES_DB_BUS: "${POSTGRES_DB_BUS:-shamell_bus}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./ops/pi/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  bff:
    build:
      context: .
      dockerfile: services_rs/bff_gateway/Dockerfile
    image: shamell-bff-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8080"
      DB_URL: "${DB_URL:-postgresql://shamell:shamell@db:5432/shamell_core}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:-dev-internal-secret}"
      PAYMENTS_INTERNAL_SECRET: "${PAYMENTS_INTERNAL_SECRET:-dev-payments-secret}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:-dev-bus-secret}"
      BFF_REQUIRE_INTERNAL_SECRET: "${BFF_REQUIRE_INTERNAL_SECRET:-true}"
      BFF_ENFORCE_ROUTE_AUTHZ: "${BFF_ENFORCE_ROUTE_AUTHZ:-false}"
      BFF_ROLE_HEADER_SECRET: "${BFF_ROLE_HEADER_SECRET:-}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
      PAYMENTS_BASE_URL: "${PAYMENTS_BASE_URL:-http://payments:8082}"
      CHAT_BASE_URL: "${CHAT_BASE_URL:-http://chat:8081}"
      BUS_BASE_URL: "${BUS_BASE_URL:-http://bus:8083}"
      AUTH_EXPOSE_CODES: "${AUTH_EXPOSE_CODES:-false}"
      BFF_MAX_BODY_BYTES: "${BFF_MAX_BODY_BYTES:-1048576}"
      BFF_MAX_UPSTREAM_BODY_BYTES: "${BFF_MAX_UPSTREAM_BODY_BYTES:-1048576}"
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      db:
        condition: service_healthy
      chat:
        condition: service_healthy
      payments:
        condition: service_healthy
      bus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  chat:
    build:
      context: .
      dockerfile: services_rs/chat_service/Dockerfile
    image: shamell-chat-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8081"
      CHAT_DB_URL: "${CHAT_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_chat}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:-dev-internal-secret}"
      CHAT_REQUIRE_INTERNAL_SECRET: "${CHAT_REQUIRE_INTERNAL_SECRET:-true}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  payments:
    build:
      context: .
      dockerfile: services_rs/payments_service/Dockerfile
    image: shamell-payments-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8082"
      PAYMENTS_DB_URL: "${PAYMENTS_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_payments}"
      INTERNAL_API_SECRET: "${PAYMENTS_INTERNAL_SECRET:-dev-payments-secret}"
      BUS_PAYMENTS_INTERNAL_SECRET: "${BUS_PAYMENTS_INTERNAL_SECRET:-dev-bus-payments-secret}"
      PAYMENTS_REQUIRE_INTERNAL_SECRET: "${PAYMENTS_REQUIRE_INTERNAL_SECRET:-true}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
      DEFAULT_CURRENCY: "${DEFAULT_CURRENCY:-SYP}"
      DEV_ENABLE_TOPUP: "${DEV_ENABLE_TOPUP:-true}"
      MERCHANT_FEE_BPS: "${MERCHANT_FEE_BPS:-150}"
      FEE_WALLET_PHONE: "${FEE_WALLET_PHONE:-+963999999999}"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  bus:
    build:
      context: .
      dockerfile: services_rs/bus_service/Dockerfile
    image: shamell-bus-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8083"
      BUS_DB_URL: "${BUS_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_bus}"
      BUS_TICKET_SECRET: "${BUS_TICKET_SECRET:-dev-bus-ticket-secret}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:-dev-bus-secret}"
      BUS_REQUIRE_INTERNAL_SECRET: "${BUS_REQUIRE_INTERNAL_SECRET:-true}"
      PAYMENTS_BASE_URL: "${PAYMENTS_BASE_URL:-http://payments:8082}"
      BUS_PAYMENTS_INTERNAL_SECRET: "${BUS_PAYMENTS_INTERNAL_SECRET:-dev-bus-payments-secret}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
    depends_on:
      db:
        condition: service_healthy
      payments:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8083/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.5.2
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./ops/livekit:/etc/livekit:ro
    ports:
      - "127.0.0.1:7880:7880"
      - "127.0.0.1:7881:7881"
      - "127.0.0.1:7882:7882/udp"
    restart: unless-stopped

volumes:
  postgres_data:

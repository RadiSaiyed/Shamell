services:
  db:
    image: postgres:16-alpine@sha256:97ff59a4e30e08d1c11bdcd9455e7832368c0572b576c9092cde2df4ae5552a3
    init: true
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-shamell}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-shamell}"
      POSTGRES_DB: "${POSTGRES_DB:-postgres}"
      POSTGRES_DB_CORE: "${POSTGRES_DB_CORE:-shamell_core}"
      POSTGRES_DB_CHAT: "${POSTGRES_DB_CHAT:-shamell_chat}"
      POSTGRES_DB_PAYMENTS: "${POSTGRES_DB_PAYMENTS:-shamell_payments}"
      POSTGRES_DB_BUS: "${POSTGRES_DB_BUS:-shamell_bus}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./ops/pi/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  bff:
    build:
      context: .
      dockerfile: services_rs/bff_gateway/Dockerfile
    image: shamell-bff-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      SHAMELL_DEPLOYMENT_PROFILE: "${SHAMELL_DEPLOYMENT_PROFILE:-root-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8080"
      DB_URL: "${DB_URL:-postgresql://shamell:shamell@db:5432/shamell_core}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:-dev-internal-secret}"
      PAYMENTS_INTERNAL_SECRET: "${PAYMENTS_INTERNAL_SECRET:-dev-payments-secret}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:-dev-bus-secret}"
      BFF_REQUIRE_INTERNAL_SECRET: "${BFF_REQUIRE_INTERNAL_SECRET:-true}"
      BFF_ENFORCE_ROUTE_AUTHZ: "${BFF_ENFORCE_ROUTE_AUTHZ:-false}"
      BFF_ROLE_HEADER_SECRET: "${BFF_ROLE_HEADER_SECRET:-}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
      PAYMENTS_BASE_URL: "${PAYMENTS_BASE_URL:-http://payments:8082}"
      CHAT_BASE_URL: "${CHAT_BASE_URL:-http://chat:8081}"
      BUS_BASE_URL: "${BUS_BASE_URL:-http://bus:8083}"
      AUTH_ACCOUNT_CREATE_WINDOW_SECS: "${AUTH_ACCOUNT_CREATE_WINDOW_SECS:-86400}"
      AUTH_ACCOUNT_CREATE_MAX_PER_IP: "${AUTH_ACCOUNT_CREATE_MAX_PER_IP:-500}"
      AUTH_ACCOUNT_CREATE_MAX_PER_DEVICE: "${AUTH_ACCOUNT_CREATE_MAX_PER_DEVICE:-3}"
      AUTH_ACCOUNT_CREATE_ENABLED: "${AUTH_ACCOUNT_CREATE_ENABLED:-true}"
      AUTH_ACCOUNT_CREATE_POW_ENABLED: "${AUTH_ACCOUNT_CREATE_POW_ENABLED:-false}"
      AUTH_ACCOUNT_CREATE_POW_TTL_SECS: "${AUTH_ACCOUNT_CREATE_POW_TTL_SECS:-300}"
      AUTH_ACCOUNT_CREATE_POW_DIFFICULTY_BITS: "${AUTH_ACCOUNT_CREATE_POW_DIFFICULTY_BITS:-18}"
      AUTH_ACCOUNT_CREATE_POW_SECRET: "${AUTH_ACCOUNT_CREATE_POW_SECRET:-}"
      AUTH_ACCOUNT_CREATE_HARDWARE_ATTESTATION_ENABLED: "${AUTH_ACCOUNT_CREATE_HARDWARE_ATTESTATION_ENABLED:-false}"
      AUTH_ACCOUNT_CREATE_REQUIRE_HARDWARE_ATTESTATION: "${AUTH_ACCOUNT_CREATE_REQUIRE_HARDWARE_ATTESTATION:-false}"
      AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_TEAM_ID: "${AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_TEAM_ID:-}"
      AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_KEY_ID: "${AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_KEY_ID:-}"
      AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_PRIVATE_KEY_P8_B64: "${AUTH_ACCOUNT_CREATE_APPLE_DEVICECHECK_PRIVATE_KEY_P8_B64:-}"
      AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_SERVICE_ACCOUNT_JSON_B64: "${AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_SERVICE_ACCOUNT_JSON_B64:-}"
      AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_ALLOWED_PACKAGE_NAMES: "${AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_ALLOWED_PACKAGE_NAMES:-}"
      AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_STRONG_INTEGRITY: "${AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_STRONG_INTEGRITY:-false}"
      AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_PLAY_RECOGNIZED: "${AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_PLAY_RECOGNIZED:-false}"
      AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_LICENSED: "${AUTH_ACCOUNT_CREATE_GOOGLE_PLAY_INTEGRITY_REQUIRE_LICENSED:-false}"
      AUTH_ACCOUNT_CREATE_CHALLENGE_WINDOW_SECS: "${AUTH_ACCOUNT_CREATE_CHALLENGE_WINDOW_SECS:-300}"
      AUTH_ACCOUNT_CREATE_CHALLENGE_MAX_PER_IP: "${AUTH_ACCOUNT_CREATE_CHALLENGE_MAX_PER_IP:-2000}"
      AUTH_ACCOUNT_CREATE_CHALLENGE_MAX_PER_DEVICE: "${AUTH_ACCOUNT_CREATE_CHALLENGE_MAX_PER_DEVICE:-60}"
      AUTH_DEVICE_LOGIN_WEB_ENABLED: "${AUTH_DEVICE_LOGIN_WEB_ENABLED:-true}"
      AUTH_BIOMETRIC_TOKEN_TTL_SECS: "${AUTH_BIOMETRIC_TOKEN_TTL_SECS:-31536000}"
      AUTH_BIOMETRIC_LOGIN_WINDOW_SECS: "${AUTH_BIOMETRIC_LOGIN_WINDOW_SECS:-300}"
      AUTH_BIOMETRIC_LOGIN_MAX_PER_IP: "${AUTH_BIOMETRIC_LOGIN_MAX_PER_IP:-60}"
      AUTH_BIOMETRIC_LOGIN_MAX_PER_DEVICE: "${AUTH_BIOMETRIC_LOGIN_MAX_PER_DEVICE:-30}"
      AUTH_CONTACT_INVITE_TTL_SECS: "${AUTH_CONTACT_INVITE_TTL_SECS:-86400}"
      AUTH_CONTACT_INVITE_WINDOW_SECS: "${AUTH_CONTACT_INVITE_WINDOW_SECS:-300}"
      AUTH_CONTACT_INVITE_CREATE_MAX_PER_IP: "${AUTH_CONTACT_INVITE_CREATE_MAX_PER_IP:-120}"
      AUTH_CONTACT_INVITE_CREATE_MAX_PER_PHONE: "${AUTH_CONTACT_INVITE_CREATE_MAX_PER_PHONE:-60}"
      AUTH_CONTACT_INVITE_REDEEM_MAX_PER_IP: "${AUTH_CONTACT_INVITE_REDEEM_MAX_PER_IP:-500}"
      AUTH_CONTACT_INVITE_REDEEM_MAX_PER_PHONE: "${AUTH_CONTACT_INVITE_REDEEM_MAX_PER_PHONE:-120}"
      AUTH_CONTACT_INVITE_REDEEM_MAX_PER_TOKEN: "${AUTH_CONTACT_INVITE_REDEEM_MAX_PER_TOKEN:-10}"
      BFF_MAX_BODY_BYTES: "${BFF_MAX_BODY_BYTES:-1048576}"
      BFF_MAX_UPSTREAM_BODY_BYTES: "${BFF_MAX_UPSTREAM_BODY_BYTES:-1048576}"
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      db:
        condition: service_healthy
      chat:
        condition: service_healthy
      payments:
        condition: service_healthy
      bus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "-H", "Host: bff", "http://127.0.0.1:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  chat:
    build:
      context: .
      dockerfile: services_rs/chat_service/Dockerfile
    image: shamell-chat-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8081"
      CHAT_DB_URL: "${CHAT_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_chat}"
      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET:-dev-internal-secret}"
      CHAT_REQUIRE_INTERNAL_SECRET: "${CHAT_REQUIRE_INTERNAL_SECRET:-true}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "-H", "Host: chat", "http://127.0.0.1:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  payments:
    build:
      context: .
      dockerfile: services_rs/payments_service/Dockerfile
    image: shamell-payments-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8082"
      PAYMENTS_DB_URL: "${PAYMENTS_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_payments}"
      INTERNAL_API_SECRET: "${PAYMENTS_INTERNAL_SECRET:-dev-payments-secret}"
      BUS_PAYMENTS_INTERNAL_SECRET: "${BUS_PAYMENTS_INTERNAL_SECRET:-dev-bus-payments-secret}"
      PAYMENTS_REQUIRE_INTERNAL_SECRET: "${PAYMENTS_REQUIRE_INTERNAL_SECRET:-true}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
      DEFAULT_CURRENCY: "${DEFAULT_CURRENCY:-SYP}"
      DEV_ENABLE_TOPUP: "${DEV_ENABLE_TOPUP:-true}"
      MERCHANT_FEE_BPS: "${MERCHANT_FEE_BPS:-150}"
      FEE_WALLET_ACCOUNT_ID: "${FEE_WALLET_ACCOUNT_ID:-}"
      FEE_WALLET_PHONE: "${FEE_WALLET_PHONE:-+963999999999}"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "-H", "Host: payments", "http://127.0.0.1:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  bus:
    build:
      context: .
      dockerfile: services_rs/bus_service/Dockerfile
    image: shamell-bus-rs:dev
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      ENV: "${ENV:-dev}"
      APP_HOST: "0.0.0.0"
      APP_PORT: "8083"
      BUS_DB_URL: "${BUS_DB_URL:-postgresql://shamell:shamell@db:5432/shamell_bus}"
      BUS_TICKET_SECRET: "${BUS_TICKET_SECRET:-dev-bus-ticket-secret}"
      BUS_INTERNAL_SECRET: "${BUS_INTERNAL_SECRET:-dev-bus-secret}"
      BUS_REQUIRE_INTERNAL_SECRET: "${BUS_REQUIRE_INTERNAL_SECRET:-true}"
      PAYMENTS_BASE_URL: "${PAYMENTS_BASE_URL:-http://payments:8082}"
      BUS_PAYMENTS_INTERNAL_SECRET: "${BUS_PAYMENTS_INTERNAL_SECRET:-dev-bus-payments-secret}"
      ALLOWED_HOSTS: "${ALLOWED_HOSTS:-localhost,127.0.0.1}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}"
    depends_on:
      db:
        condition: service_healthy
      payments:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "-H", "Host: bus", "http://127.0.0.1:8083/health"]
      interval: 10s
      timeout: 3s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.5.2@sha256:fb032a59b5d926efae328ba46e54fba69cce5bd09cd4c8ed64d0302f6ed9c6cf
    init: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    command: ["--config", "/etc/livekit/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "{${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret}${LIVEKIT_KEYS_EXTRA:-}}"
    volumes:
      - ./ops/livekit:/etc/livekit:ro
    ports:
      - "127.0.0.1:7880:7880"
      - "127.0.0.1:7881:7881"
      - "127.0.0.1:7882:7882/udp"
    restart: unless-stopped

volumes:
  postgres_data:

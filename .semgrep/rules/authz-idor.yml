rules:
  - id: shamell.authz.wallet-query-missing-actor-scope
    message: >
      Potential wallet-scoped query without actor/user ownership checks.
      Enforce wallet_id + actor/user scoping in the same query or authz guard.
    severity: ERROR
    languages: [python, javascript, typescript, go, dart]
    metadata:
      category: security
      cwe: "CWE-639: Authorization Bypass Through User-Controlled Key"
      owasp: "A01:2021 - Broken Access Control"
      confidence: medium
    patterns:
      - pattern-regex: (?is)\b(SELECT|UPDATE|DELETE)\b[\s\S]{0,500}\bWHERE\b[\s\S]{0,250}\bwallet_id\b
      - pattern-not-regex: (?is)\b(actor_id|user_id|owner_id|account_id)\b

  - id: shamell.authz.trusting-client-internal-headers
    message: >
      Potential trust of client-provided internal header detected.
      Treat x-internal/x-service/x-admin headers as untrusted unless verified via gateway/mTLS.
    severity: ERROR
    languages: [python, javascript, typescript, go, dart]
    metadata:
      category: security
      cwe: "CWE-345: Insufficient Verification of Data Authenticity"
      owasp: "A01:2021 - Broken Access Control"
      confidence: medium
    pattern-regex: (?is)\b(req|request|ctx)\b[\s\S]{0,120}\b(headers|get|header)\b[\s\S]{0,120}["']x-(internal|service|admin)[^"']*["']

  - id: shamell.injection.unsafe-token-query-construction
    message: >
      Potential unsafe query construction using token fields with concatenation/interpolation.
      Use parameterized statements and validated bind variables.
    severity: ERROR
    languages: [python, javascript, typescript, go, dart]
    metadata:
      category: security
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command"
      owasp: "A03:2021 - Injection"
      confidence: medium
    patterns:
      - pattern-regex: (?is)\b(sql|query)\b\s*[:=]\s*["'`]?[\s\S]{0,200}\b(token|auth_token|session_token|refresh_token)\b
      - pattern-regex: (?is)(\+|\$\{|format\(|f["'])
